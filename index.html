<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›™äººå°æ‰‹å¸³</title>
    <!-- å¼•å…¥å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Zen+Maru+Gothic:wght@500;900&display=swap" rel="stylesheet">
    <!-- ç‰¹æ•ˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #f6f6f4;
            --card-bg: #ffffff;
            --text-main: #444;
            --text-light: #999;
            
            --good-color: #e56b6f; /* ç´… */
            --bad-color: #457b9d;  /* è— */
            --food-color: #f4a261; /* æ©˜ (é£Ÿç‰©) */

            --shadow: 0 4px 15px rgba(0,0,0,0.06);
            --radius: 20px;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0; /* ç§»é™¤ paddingï¼Œç”± container æ§åˆ¶ */
            background-color: var(--bg-color);
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢æ•´é«”æ²å‹•ï¼Œå…§å®¹å€è‡ªå·±æ²å‹• */
        }

        /* --- å…±ç”¨å®¹å™¨ (æœ‰æ²è»¸) --- */
        .page-container {
            height: calc(100vh - var(--nav-height));
            overflow-y: auto;
            padding: 20px 20px 40px 20px;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            align-items: center;
        }

        .page-container.active { display: flex; }

        /* --- åº•éƒ¨å°èˆªåˆ— --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: #fff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 0.8rem;
            cursor: pointer;
            transition: color 0.3s;
            width: 50%;
            height: 100%;
        }

        .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
        
        .nav-item.active { color: var(--text-main); font-weight: bold; }
        .nav-item.active .nav-icon { transform: scale(1.1); transition: transform 0.2s; }

        /* ç‰¹å®šé ç±¤é¡è‰² */
        .nav-item.active[data-target="card"] { color: var(--good-color); }
        .nav-item.active[data-target="food"] { color: var(--food-color); }


        /* ========== é é¢ 1: é›†é»å¡æ¨£å¼ ========== */
        
        /* åˆ‡æ›é–‹é—œ */
        .switch-container {
            display: flex;
            background: #e9e9e9;
            border-radius: 50px;
            padding: 4px;
            margin-bottom: 20px;
            width: 100%; max-width: 350px;
            position: relative;
        }
        .switch-btn {
            flex: 1; text-align: center; padding: 10px 0;
            font-weight: bold; z-index: 2; cursor: pointer;
            transition: color 0.3s; font-size: 0.9rem;
        }
        .switch-bg {
            position: absolute; top: 4px; left: 4px;
            width: calc(50% - 4px); height: calc(100% - 8px);
            background: #fff; border-radius: 50px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1;
        }
        .mode-good .switch-bg { transform: translateX(0); }
        .mode-bad .switch-bg { transform: translateX(100%); }
        .mode-good .switch-btn.active { color: var(--good-color); }
        .mode-bad .switch-btn.active { color: var(--bad-color); }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px 20px;
            width: 100%; max-width: 380px;
            border-top: 6px solid var(--good-color);
            transition: border-color 0.3s;
        }
        .mode-bad .card { border-top-color: var(--bad-color); }

        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .card-title { font-size: 1.4rem; font-weight: 900; margin: 0; }
        .counter { font-size: 1.8rem; font-weight: 900; font-family: 'Zen Maru Gothic'; }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .slot {
            aspect-ratio: 1/1; border: 1px solid #eee; border-radius: 10px;
            background: #fafafa; display: flex; justify-content: center; align-items: center;
            position: relative; cursor: pointer;
        }
        .slot.stamped .stamp-mark { transform: scale(1) rotate(var(--r)); opacity: 1; }
        .stamp-mark {
            width: 80%; height: 80%; border-radius: 50%; border: 2px solid currentColor;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.8rem; font-weight: 900; opacity: 0; transform: scale(0);
            transition: 0.3s;
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.5'/%3E%3C/svg%3E");
        }
        .mode-good .stamp-mark { color: var(--good-color); }
        .mode-bad .stamp-mark { color: var(--bad-color); }


        /* ========== é é¢ 2: åƒä»€éº¼æ¨£å¼ ========== */

        .food-header {
            text-align: center; margin-bottom: 20px;
            width: 100%; max-width: 380px;
        }
        
        .result-box {
            background: #fff;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            border: 2px solid var(--food-color);
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .result-text {
            font-size: 2rem;
            font-weight: 900;
            color: var(--food-color);
            margin-bottom: 10px;
            min-height: 3rem; /* é¿å…è·³å‹• */
        }

        .btn-spin {
            background: var(--food-color);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(244, 162, 97, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-spin:active { transform: scale(0.95); }
        .btn-spin:disabled { background: #ddd; box-shadow: none; cursor: not-allowed; }

        .food-list-container {
            width: 100%; max-width: 380px;
            background: #fff;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .food-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tag {
            background: #fdf0e6;
            color: #d38445;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: fadeIn 0.3s;
        }
        
        .tag.highlight {
            background: var(--food-color);
            color: white;
            transform: scale(1.1);
        }

        .tag-delete {
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.5;
        }
        .tag-delete:hover { opacity: 1; }

        .add-food-group {
            display: flex;
            gap: 10px;
        }
        
        .input-food {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            outline: none;
        }
        .btn-add {
            background: #eee;
            border: none;
            width: 40px;
            border-radius: 10px;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }


        /* --- ç™»å…¥é®ç½© & Modal (æ²¿ç”¨) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-card { background: #fff; padding: 40px; border-radius: 20px; text-align: center; }
        .login-input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0; text-align: center; font-size: 1.1rem; }
        .btn-primary { background: #333; color: white; border: none; padding: 10px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: #fff; width: 100%; max-width: 320px;
            padding: 25px; border-radius: 20px;
            animation: popUp 0.3s ease;
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; resize: none; margin: 10px 0 20px 0; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group button { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #f0f0f0; color: #666; }

    </style>
</head>
<body>

    <!-- 1. ç™»å…¥å±¤ -->
    <div id="login-overlay">
        <div class="login-card">
            <h2>ä½ æ˜¯èª°å‘¢ï¼Ÿ</h2>
            <input type="text" id="inputName" class="login-input" placeholder="è¼¸å…¥åå­—..." maxlength="8">
            <button class="btn-primary" onclick="handleLogin()">é€²å…¥</button>
        </div>
    </div>

    <!-- 2. åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('card')" data-target="card">
            <div class="nav-icon">â¤ï¸</div>
            <span>é›†é»å¡</span>
        </div>
        <div class="nav-item" onclick="switchPage('food')" data-target="food">
            <div class="nav-icon">ğŸ½ï¸</div>
            <span>åƒä»€éº¼</span>
        </div>
    </nav>

    <!-- 3. é é¢A: é›†é»å¡ -->
    <div id="page-card" class="page-container active">
        <div class="switch-container mode-good" id="switchContainer">
            <div class="switch-bg"></div>
            <div class="switch-btn active" id="btnGood" onclick="toggleMode('good')">å¥½å¯¶å¯¶</div>
            <div class="switch-btn" id="btnBad" onclick="toggleMode('bad')">å£å¯¶å¯¶</div>
        </div>

        <div class="card">
            <div class="header">
                <div>
                    <div style="font-size:0.9rem; color:#999;" id="displayName">å¯¶å¯¶ çš„</div>
                    <div class="card-title" id="cardTitleText" style="color:var(--good-color)">å¥½å¯¶å¯¶é›†é»</div>
                </div>
                <div class="counter" id="scoreText" style="color:var(--good-color)">0<span>/10</span></div>
            </div>
            <div class="grid" id="gridContainer"></div>
        </div>
    </div>

    <!-- 4. é é¢B: åƒä»€éº¼ -->
    <div id="page-food" class="page-container">
        <div class="food-header">
            <h2 style="margin: 0; color: var(--text-main);">ä»Šå¤©åƒä»€éº¼ï¼Ÿ</h2>
            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #999;">åˆ¥å†èªªã€Œéš¨ä¾¿ã€äº†ï¼</p>
        </div>

        <div class="result-box">
            <div class="result-text" id="foodResult">?</div>
            <button class="btn-spin" id="spinBtn" onclick="pickFood()">å¹«æˆ‘æ±ºå®šï¼</button>
        </div>

        <div class="food-list-container">
            <h3 style="margin-top:0; font-size:1rem;">å€™é¸æ¸…å–®</h3>
            <div class="food-tags" id="foodTags">
                <!-- JS ç”Ÿæˆ -->
            </div>
            
            <div class="add-food-group">
                <input type="text" id="newFoodInput" class="input-food" placeholder="æƒ³åŠ ä»€éº¼..." onkeypress="if(event.key==='Enter') addFood()">
                <button class="btn-add" onclick="addFood()">+</button>
            </div>
        </div>
    </div>

    <!-- 5. Modal -->
    <div class="modal-wrap" id="modal">
        <div class="modal-content">
            <h3 id="mTitle" style="margin-top:0">æ¨™é¡Œ</h3>
            <p id="mDate" style="color:#999; font-size:0.8rem;"></p>
            
            <div id="inputSection">
                <textarea id="reasonInput" placeholder="å¯«ä¸‹ç†ç”±..."></textarea>
                <div class="btn-group">
                    <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" onclick="confirmStamp()">ç¢ºèª</button>
                </div>
            </div>

            <div id="viewSection" style="display:none;">
                <p id="reasonText" style="background:#f9f9f9; padding:10px; border-radius:10px;"></p>
                <div class="btn-group">
                    <button class="btn-cancel" onclick="closeModal()">é—œé–‰</button>
                    <button onclick="deletePoint()" style="background:#ffebee; color:red;">åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè³‡æ–™ ---
        const DEFAULT_FOODS = ["å£½å¸", "æ—¥å¼ç°¡é¤", "æ‹‰éºµ", "å’–å“©", "éº¥ç•¶å‹", "é¹¹é…¥é›", "ç«é‹", "æ»·å‘³"];
        
        const STATE = {
            user: "",
            mode: "good",
            goodPoints: [],
            badPoints: [],
            foodList: [...DEFAULT_FOODS]
        };

        // --- DOM Cache ---
        const els = {
            login: document.getElementById('login-overlay'),
            inputName: document.getElementById('inputName'),
            displayName: document.getElementById('displayName'),
            // Card Page
            pageCard: document.getElementById('page-card'),
            switchContainer: document.getElementById('switchContainer'),
            btnGood: document.getElementById('btnGood'),
            btnBad: document.getElementById('btnBad'),
            cardTitle: document.getElementById('cardTitleText'),
            score: document.getElementById('scoreText'),
            grid: document.getElementById('gridContainer'),
            // Food Page
            pageFood: document.getElementById('page-food'),
            foodResult: document.getElementById('foodResult'),
            spinBtn: document.getElementById('spinBtn'),
            foodTags: document.getElementById('foodTags'),
            newFoodInput: document.getElementById('newFoodInput'),
            // Modal
            modal: document.getElementById('modal'),
            mTitle: document.getElementById('mTitle'),
            mDate: document.getElementById('mDate'),
            inputSec: document.getElementById('inputSection'),
            viewSec: document.getElementById('viewSection'),
            reasonInput: document.getElementById('reasonInput'),
            reasonText: document.getElementById('reasonText')
        };

        let currentFocusIndex = -1;

        // --- åˆå§‹åŒ– ---
        function init() {
            const saved = localStorage.getItem('love_card_v4');
            if(saved) {
                const data = JSON.parse(saved);
                STATE.user = data.user || "";
                STATE.goodPoints = data.goodPoints || [];
                STATE.badPoints = data.badPoints || [];
                // ç¢ºä¿é£Ÿç‰©æ¸…å–®å­˜åœ¨
                if(data.foodList && data.foodList.length > 0) {
                    STATE.foodList = data.foodList;
                }
                
                if(STATE.user) {
                    els.login.style.display = 'none';
                    els.displayName.innerText = STATE.user + " çš„";
                    renderCard();
                    renderFoodList();
                }
            } else {
                renderFoodList(); // æ¸²æŸ“é è¨­é£Ÿç‰©
            }
        }

        function save() {
            localStorage.setItem('love_card_v4', JSON.stringify(STATE));
        }

        // --- å°èˆªèˆ‡ç™»å…¥ ---
        window.handleLogin = function() {
            const val = els.inputName.value.trim();
            if(!val) return alert("è«‹è¼¸å…¥åå­—");
            STATE.user = val;
            save();
            els.login.style.display = 'none';
            els.displayName.innerText = STATE.user + " çš„";
            renderCard();
        }

        window.switchPage = function(target) {
            // æ›´æ–° Nav æ¨£å¼
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.dataset.target === target) item.classList.add('active');
            });
            // åˆ‡æ›é é¢é¡¯ç¤º
            els.pageCard.classList.remove('active');
            els.pageFood.classList.remove('active');
            
            if(target === 'card') els.pageCard.classList.add('active');
            if(target === 'food') els.pageFood.classList.add('active');
        }

        // ================= é›†é»å¡é‚è¼¯ =================

        window.toggleMode = function(mode) {
            STATE.mode = mode;
            if(mode === 'good') {
                els.switchContainer.className = "switch-container mode-good";
                els.btnGood.classList.add('active');
                els.btnBad.classList.remove('active');
                els.cardTitle.innerText = "å¥½å¯¶å¯¶é›†é»";
                els.cardTitle.style.color = "var(--good-color)";
                els.score.style.color = "var(--good-color)";
            } else {
                els.switchContainer.className = "switch-container mode-bad";
                els.btnBad.classList.add('active');
                els.btnGood.classList.remove('active');
                els.cardTitle.innerText = "å£å¯¶å¯¶ç´€éŒ„";
                els.cardTitle.style.color = "var(--bad-color)";
                els.score.style.color = "var(--bad-color)";
            }
            renderCard();
        }

        function renderCard() {
            els.grid.innerHTML = "";
            const list = STATE.mode === 'good' ? STATE.goodPoints : STATE.badPoints;
            els.score.innerHTML = `${list.length}<span>/10</span>`;

            for(let i=0; i<10; i++) {
                const item = list[i];
                const slot = document.createElement('div');
                slot.className = 'slot';
                const rot = Math.floor(Math.random()*40 - 20);

                if(item) {
                    slot.classList.add('stamped');
                    const markChar = STATE.mode === 'good' ? 'å„ª' : 'ç½°';
                    slot.innerHTML = `<div class="stamp-mark" style="--r:${rot}deg">${markChar}</div>`;
                    slot.onclick = () => openViewModal(i, item);
                } else if(i === list.length) {
                    slot.style.border = "2px dashed #bbb";
                    slot.innerHTML = "<span style='color:#ccc; font-size:2rem;'>+</span>";
                    slot.onclick = () => openInputModal();
                } else {
                    slot.style.opacity = 0.5;
                    slot.style.background = "#f0f0f0";
                }
                els.grid.appendChild(slot);
            }
        }

        // Modal æ“ä½œ
        window.openInputModal = function() {
            els.modal.style.display = 'flex';
            els.inputSec.style.display = 'block';
            els.viewSec.style.display = 'none';
            els.mTitle.innerText = STATE.mode === 'good' ? "Good Job!" : "Oh No...";
            els.mDate.innerText = new Date().toLocaleDateString();
            els.reasonInput.value = "";
            els.reasonInput.focus();
        }
        window.openViewModal = function(idx, item) {
            currentFocusIndex = idx;
            els.modal.style.display = 'flex';
            els.inputSec.style.display = 'none';
            els.viewSec.style.display = 'block';
            els.mTitle.innerText = "è©³ç´°è¨˜éŒ„";
            els.mDate.innerText = item.date;
            els.reasonText.innerText = item.reason;
        }
        window.closeModal = function() { els.modal.style.display = 'none'; }
        
        window.confirmStamp = function() {
            const reason = els.reasonInput.value.trim() || "ç„¡ç†ç”±";
            const item = { reason, date: new Date().toLocaleString() };
            if(STATE.mode === 'good') {
                STATE.goodPoints.push(item);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors:['#e56b6f', '#ffd60a'] });
            } else {
                STATE.badPoints.push(item);
            }
            save(); renderCard(); closeModal();
        }
        window.deletePoint = function() {
            if(!confirm("åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) return;
            const list = STATE.mode === 'good' ? STATE.goodPoints : STATE.badPoints;
            list.splice(currentFocusIndex, 1);
            save(); renderCard(); closeModal();
        }

        // ================= åƒä»€éº¼é‚è¼¯ =================

        function renderFoodList() {
            els.foodTags.innerHTML = "";
            STATE.foodList.forEach((food, index) => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.id = `food-tag-${index}`;
                tag.innerHTML = `
                    ${food} 
                    <span class="tag-delete" onclick="deleteFood(${index})">Ã—</span>
                `;
                els.foodTags.appendChild(tag);
            });
        }

        window.addFood = function() {
            const val = els.newFoodInput.value.trim();
            if(!val) return;
            STATE.foodList.push(val);
            els.newFoodInput.value = "";
            save();
            renderFoodList();
        }

        window.deleteFood = function(index) {
            if(STATE.foodList.length <= 2) return alert("è‡³å°‘ä¿ç•™å…©å€‹é¸é …å•¦ï¼");
            STATE.foodList.splice(index, 1);
            save();
            renderFoodList();
        }

        window.pickFood = function() {
            if(STATE.foodList.length === 0) return;
            
            els.spinBtn.disabled = true;
            els.spinBtn.innerText = "é¸å–ä¸­...";
            els.foodResult.style.color = "var(--text-light)";
            
            let count = 0;
            const totalRounds = 20; // è·³å‹•æ¬¡æ•¸
            const speed = 100; // é€Ÿåº¦
            
            const interval = setInterval(() => {
                // éš¨æ©Ÿé«˜äº® Tag
                const randomIdx = Math.floor(Math.random() * STATE.foodList.length);
                
                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                document.querySelectorAll('.tag').forEach(t => t.classList.remove('highlight'));
                // åŠ ä¸Šé«˜äº®
                const targetTag = document.getElementById(`food-tag-${randomIdx}`);
                if(targetTag) targetTag.classList.add('highlight');
                
                // æ›´æ–°æ–‡å­—é¡¯ç¤º
                els.foodResult.innerText = STATE.foodList[randomIdx];

                count++;
                if(count > totalRounds) {
                    clearInterval(interval);
                    finalizePick(randomIdx);
                }
            }, speed);
        }

        function finalizePick(finalIdx) {
            const finalFood = STATE.foodList[finalIdx];
            
            // æœ€çµ‚è¦–è¦ºæ•ˆæœ
            els.foodResult.innerText = finalFood;
            els.foodResult.style.color = "var(--food-color)";
            els.foodResult.style.transform = "scale(1.2)";
            setTimeout(() => els.foodResult.style.transform = "scale(1)", 200);

            // æ”¾ç…™ç«
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.4 },
                colors: ['#f4a261', '#2a9d8f', '#e9c46a']
            });

            els.spinBtn.disabled = false;
            els.spinBtn.innerText = "å†é¸ä¸€æ¬¡";
        }

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>
