
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊóÖÈÅäË¶èÂäÉÊâãÂ∏≥</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Â≠óÈ´î -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Ê†∏ÂøÉËâ≤Á≥ª */
            --primary: #7FA9BE; 
            --primary-light: #EDF6F9; 
            --primary-dark: #5A8296;
            --accent: #E89E9B; 
            --accent-bg: #FFF5F5;
            --text: #2D3748; 
            --text-light: #718096; 
            --text-white: #FFFFFF;
            --text-done: #CBD5E0;
            --bg-body: #F7F9FC; 
            --card-bg: #FFFFFF;
            --input-bg: #F1F5F9;
            
            /* Â∞∫ÂØ∏ËÆäÊï∏ */
            --nav-height: 70px; 
            --radius-L: 24px; 
            --radius-M: 16px; 
            --radius-S: 12px;
            --shadow-card: 0 4px 15px rgba(148, 163, 184, 0.1);
            --shadow-float: 0 8px 25px rgba(127, 169, 190, 0.3);

            /* È¶¨Âç°ÈæçËâ≤Á≥ª (ËÉåÊôØËâ≤Ë™øÊ∑° - Update #2) */
            --c-spot-bg: #F2F9FD; --c-spot-line: #4299E1; --c-spot-icon: #3182CE;
            --c-food-bg: #FFFEF9; --c-food-line: #ED8936; --c-food-icon: #DD6B20;
            --c-shop-bg: #FFF9FB; --c-shop-line: #ED64A6; --c-shop-icon: #D53F8C;
            --c-trans-bg:#F8FFF9; --c-trans-line:#48BB78; --c-trans-icon: #38A169;
            --c-other-bg:#FAFCFE; --c-other-line:#718096; --c-other-icon: #4A5568;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--bg-body); color: var(--text); padding-bottom: calc(var(--nav-height) + 40px); -webkit-overflow-scrolling: touch; }
        .hidden { display: none !important; }

        /* Icons */
        .icon-svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; pointer-events: none; }
        .icon-sm { width: 16px; height: 16px; stroke-width: 2; }
        
        /* UI Components */
        .btn { border: none; border-radius: var(--radius-M); padding: 12px 20px; font-size: 0.95rem; font-weight: 700; cursor: pointer; background: white; color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; transition: all 0.2s; width: 100%;}
        .btn:active { transform: scale(0.96); filter: brightness(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(127, 169, 190, 0.4); }
        .btn-ghost { background: transparent; box-shadow: none; color: var(--text-light); padding: 8px; cursor: pointer; border: none; transition: 0.2s; width: auto; position: relative; z-index: 10;}
        .btn-ghost:active { transform: scale(0.9); color: var(--primary); }
        
        .btn-del { color: var(--accent); background: var(--accent-bg); padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s;}
        .btn-edit { color: var(--primary); background: var(--primary-light); padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 6px; transition: 0.2s;}
        .btn-del:active, .btn-edit:active { transform: scale(0.9); }

        /* Inputs */
        input, select, textarea { width: 100%; padding: 0 16px; height: 48px; min-height: 48px; border: 1px solid transparent; border-radius: var(--radius-S); background: var(--input-bg); font-size: 16px; outline: none; margin-bottom: 0; font-family: inherit; font-weight: 500; color: var(--text); transition: 0.2s; appearance: none; -webkit-appearance: none; display: flex; align-items: center;}
        textarea { padding: 14px 16px; height: auto; min-height: auto; resize: none; line-height: 1.5; }
        input:focus, textarea:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(127, 169, 190, 0.15); }
        
        /* Layout */
        .row { display: flex; gap: 12px; width: 100%; margin-bottom: 15px; align-items: flex-start;}
        .col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 6px;}
        .input-group { margin-bottom: 15px; width: 100%; }
        .card-label { font-size: 0.9rem; color: var(--text-light); font-weight: 700; margin-left: 4px; display: block; margin-bottom: 6px; }

        /* Header (Absolute Centering Fix) */
        .sticky-header { position: sticky; top: 0; z-index: 100; background: rgba(247, 249, 252, 0.95); backdrop-filter: blur(12px); padding-top: env(safe-area-inset-top); border-bottom: 1px solid rgba(0,0,0,0.03); }
        .header-top { position: relative; height: 60px; display: flex; align-items: center; padding: 0 15px; }
        .header-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 1.3rem; color: var(--text); font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 60%; text-align: center; pointer-events: none;}
        .back-btn, .btn-ghost { position: relative; z-index: 10; }
        
        .container { padding: 20px; padding-bottom: 100px; max-width: 600px; margin: 0 auto; }
        
        .card { background: var(--card-bg); border-radius: var(--radius-L); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); position: relative; border: 1px solid rgba(255,255,255,0.8); }
        .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--primary-dark); font-weight: 800; font-size: 1.1rem; }

        /* Nav & FAB */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 420px; height: var(--nav-height); background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; border-radius: 40px; box-shadow: var(--shadow-float); z-index: 1000; border: 1px solid rgba(255,255,255,0.5); padding: 0 10px;}
        .nav-item { flex: 1; border: none; background: none; color: #C4C8D0; font-size: 0.7rem; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 0; transition: 0.3s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active svg { stroke-width: 2.5; filter: drop-shadow(0 2px 4px rgba(127,169,190,0.3));}
        
        .fab { position: fixed; bottom: 105px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-float); z-index: 900; cursor: pointer; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .fab:active { transform: scale(0.9) rotate(90deg); background: var(--primary-dark); }
        
        /* Tabs */
        .sub-nav { display: flex; padding: 0 20px 10px; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .sub-nav-btn { flex: 0 0 auto; padding: 8px 18px; border: 1px solid transparent; background: white; border-radius: 30px; font-size: 0.9rem; color: var(--text-light); font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.04); transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .sub-nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(127, 169, 190, 0.3); transform: translateY(-1px); }

        /* Shopping List Item Style (New Layout V2) */
        .check-item { display: flex; padding: 16px; background: white; border-radius: var(--radius-M); margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #F0F0F0; transition: 0.2s; align-items: stretch; }
        .check-item:active { transform: scale(0.99); background: #FAFAFA;}
        
        .check-left { flex: 1; display: flex; flex-direction: column; min-width: 0; gap: 8px; justify-content: center;}
        .check-name-row { display: flex; align-items: center; gap: 12px; }
        .check-box { width: 24px; height: 24px; border: 2px solid var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background: white; transition: 0.2s; }
        .checked .check-box { background: var(--primary); }
        .checked .check-box::after { content: '‚úì'; color: white; font-size: 16px; font-weight: bold; }
        .check-text { font-weight: bold; font-size: 1.2rem; color: var(--text); transition: 0.2s; line-height: 1.3; }
        
        .check-separator { height: 1px; border-bottom: 2px dashed #E2E8F0; width: 100%; }
        
        .check-meta-row { display: flex; gap: 8px; align-items: center; padding-left: 36px; }
        .meta-pill { font-size: 0.75rem; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .meta-price { background: #F0FFF4; color: #38A169; }
        .meta-loc { background: #EBF8FF; color: #3182CE; }
        .meta-pill svg { width: 12px; height: 12px; }

        .check-right { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; padding-left: 10px; flex-shrink: 0; min-width: 60px; }
        .member-badge-pill { font-size: 0.7rem; background: var(--text); color: white; padding: 4px 10px; border-radius: 10px; font-weight: bold; opacity: 0.8;}
        .btn-list-del { width: 32px; height: 32px; color: #E53E3E; background: #FFF5F5; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .btn-list-del:active { transform: scale(0.9); }

        .checked .check-text { text-decoration: line-through; color: var(--text-done); }
        .checked .meta-pill { opacity: 0.5; }

        /* Items (Common) */
        .info-card-item { background: #FFFFFF; border-radius: var(--radius-M); padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #F0F0F0; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .info-card-content { flex: 1; min-width: 0; }
        .info-card-sub { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; display: flex; align-items: center; gap: 5px; font-weight: 500;}
        .info-card-sub .icon-svg { width: 16px; height: 16px; }
        .item-icon-box { width: 42px; height: 42px; border-radius: 12px; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .note-row { display: flex; align-items: center; gap: 5px; color: var(--text-light); font-size: 0.8rem; margin-top: 4px; }
        .note-row svg { width: 14px; height: 14px; flex-shrink: 0; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal:not(.hidden) { opacity: 1; visibility: visible; }
        .modal-content { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 28px; max-height: 85vh; overflow-y: auto; transform: scale(0.95); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .modal:not(.hidden) .modal-content { transform: scale(1); }
        .modal h3 { margin: 0 0 20px; text-align: center; color: var(--primary); font-size: 1.3rem; }

        /* Boarding Pass */
        .bp-card { background: white; border-radius: var(--radius-M); margin-bottom: 25px; overflow: hidden; position: relative; box-shadow: var(--shadow-card); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.05)); }
        .bp-header { background: var(--primary); color: white; padding: 10px; text-align: center; font-size: 0.9rem; font-weight: bold; letter-spacing: 2px; }
        .bp-body { padding: 20px 15px; display: flex; justify-content: space-between; align-items: center; }
        .bp-group { text-align: center; flex: 1; }
        .bp-code { font-size: 2rem; font-weight: 900; color: var(--text); display: block; line-height: 1; margin-bottom: 5px;}
        .bp-time { font-size: 0.9rem; color: var(--text); font-weight: bold; background: #F0F4F8; padding: 4px 8px; border-radius: 6px; display: inline-block;}
        .bp-center { display: flex; flex-direction: column; align-items: center; width: 90px; }
        .bp-line { width: 100%; height: 2px; background: #E0E0E0; position: relative; margin: 10px 0; }
        .bp-line::after { content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:20px; height:20px; background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%237FA9BE'%3E%3Cpath d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/%3E%3C/svg%3E") no-repeat center; background-size:contain; background-color:white; padding:0 2px;} 
        .bp-duration { font-size: 0.75rem; color: var(--text-light); font-weight: bold; margin-top: 4px; }

        /* Weather (Colored - Soft Blue Update #1) */
        .weather-card { border-radius: var(--radius-L); padding: 25px 20px; margin-bottom: 25px; background: linear-gradient(135deg, #A1C4FD 0%, #C2E9FB 100%); box-shadow: 0 10px 30px rgba(161, 196, 253, 0.4); border: none; position: relative; overflow: hidden; color: white;}
        .w-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .w-city { font-weight: 800; font-size: 1.2rem; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .w-desc { font-size: 0.95rem; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 6px; margin-top: 4px; font-weight: bold;}
        .w-main-temp { font-size: 3.5rem; font-weight: 900; color: white; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .w-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .w-stat { background: rgba(255,255,255,0.2); border-radius: 16px; padding: 10px 5px; text-align: center; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .w-stat-label { font-size: 0.7rem; color: rgba(255,255,255,0.8); margin-bottom: 4px; font-weight: bold; }
        .w-stat-val { font-size: 0.9rem; color: white; font-weight: 800; }

        /* Timeline & Itinerary (Colorful) */
        .timeline-wrapper { position: relative; padding-left: 10px; margin-top: 20px; padding-bottom: 20px;}
        .timeline-line { position: absolute; left: 38px; top: 15px; bottom: 15px; width: 2px; background: #E2E8F0; z-index: 0; border-radius: 2px; }
        .timeline-item { display: flex; gap: 15px; margin-bottom: 24px; position: relative; z-index: 1; align-items: flex-start; }
        .time-bubble { flex-shrink: 0; width: 56px; text-align: center; background: white; color: var(--primary-dark); border-radius: 12px; padding: 10px 0; font-weight: 800; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #EDF2F7; z-index: 2; display: flex; flex-direction: column; justify-content: center; min-height: 50px;}
        
        /* Full Colored Itinerary Cards */
        .it-card { flex: 1; border-radius: 20px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; align-items: flex-start; gap: 14px; position: relative; overflow: hidden; transition: 0.1s; border: 1px solid rgba(0,0,0,0.03);}
        .it-card:active { transform: scale(0.99); filter: brightness(0.95); }
        .it-icon { width: 36px; height: 36px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); background: white !important;}
        .btn-map-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: white; color: #4299E1; border: 1px solid rgba(0,0,0,0.05); padding: 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: 0.2s; }
        
        /* Macaron Color Backgrounds */
        .type-spot { background: var(--c-spot-bg); border-left: 4px solid var(--c-spot-line); } .type-spot .it-icon { color: var(--c-spot-icon); }
        .type-food { background: var(--c-food-bg); border-left: 4px solid var(--c-food-line); } .type-food .it-icon { color: var(--c-food-icon); }
        .type-shop { background: var(--c-shop-bg); border-left: 4px solid var(--c-shop-line); } .type-shop .it-icon { color: var(--c-shop-icon); }
        .type-transport { background: var(--c-trans-bg); border-left: 4px solid var(--c-trans-line); } .type-transport .it-icon { color: var(--c-trans-icon); }
        .type-other { background: var(--c-other-bg); border-left: 4px solid var(--c-other-line); } .type-other .it-icon { color: var(--c-other-icon); }

        /* Transport Time Styling */
        .trans-time-group { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 2px; }
        .trans-t-val { font-size: 0.8rem; font-weight: 800; color: var(--text); }
        .trans-arrow { font-size: 0.7rem; color: #CBD5E0; line-height: 0.8; }

        /* Opening Hours Badge */
        .open-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.6); color: var(--text-light); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-top: 6px; backdrop-filter: blur(4px); }
        .open-badge svg { width: 12px; height: 12px; }

        /* Night Stay */
        .night-stay-box { margin-top: 30px; background: #2D3748; color: white; border-radius: var(--radius-M); padding: 18px; display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 20px rgba(45, 55, 72, 0.3); }

        /* Countdown */
        .countdown-banner { background: linear-gradient(120deg, var(--primary-dark), var(--primary)); color: white; border-radius: var(--radius-L); padding: 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(127, 169, 190, 0.4); position: relative; overflow: hidden; }
        .countdown-banner.ended { background: linear-gradient(120deg, #A0AEC0, #718096); box-shadow: none; }
        .countdown-num { font-size: 2.2rem; font-weight: 900; line-height: 1.2; text-shadow: 0 2px 5px rgba(0,0,0,0.1); margin: 5px 0;}
        .countdown-label { font-size: 0.95rem; opacity: 0.9; }

        /* Chips & Tags */
        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 0; }
        .chip-btn { padding: 0 16px; height: 40px; border-radius: 20px; background: #F1F5F9; color: var(--text-light); border: 1px solid transparent; font-weight: bold; font-size: 0.85rem; cursor: pointer; transition: 0.2s; display: flex; align-items: center;}
        .chip-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(127,169,190,0.3); }
        
        .day-scroller { display: flex; overflow-x: auto; padding: 10px 20px; gap: 10px; scrollbar-width: none; min-height: 85px; }
        .day-chip { flex: 0 0 auto; padding: 10px 5px; border-radius: 20px; min-width: 65px; background: white; border: 1px solid #EDF2F7; color: var(--text-light); text-align: center; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
        .day-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(127, 169, 190, 0.4); transform: scale(1.05); }
        .d-num { font-size: 0.7rem; font-weight: bold; opacity: 0.8; letter-spacing: 1px;}
        .d-date { font-size: 1.1rem; font-weight: 900; line-height: 1.2;}
        .d-week { font-size: 0.75rem; font-weight: bold; }

        /* Packing Member Grid */
        .packing-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px; }
        .pack-member-chip { border: 1px solid #E2E8F0; border-radius: 12px; padding: 8px; text-align: center; font-size: 0.85rem; color: var(--text-light); cursor: pointer; background: #FAFAFA; transition: 0.2s; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 4px;}
        .pack-member-chip.checked { background: var(--primary); color: white; border-color: var(--primary); }

        /* Money List Redesign */
        .money-item-row { display: flex; align-items: center; justify-content: space-between; padding: 14px; background: white; border-radius: 16px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #F0F4F8; transition: transform 0.1s;}
        .money-item-row:active { transform: scale(0.99); }
        .money-info { display: flex; flex-direction: column; gap: 4px; }
        .money-title { font-weight: bold; font-size: 1rem; color: var(--text); }
        .money-meta { display: flex; gap: 6px; font-size: 0.75rem; color: var(--text-light); align-items: center;}
        .money-tag { background: #EDF2F7; padding: 2px 8px; border-radius: 6px; font-weight: bold; color: var(--text-light); }
        .money-amount { font-weight: 900; font-size: 1.1rem; color: var(--primary-dark); }

        /* Journal Redesign */
        .journal-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03); overflow: hidden; }
        .journal-header { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 12px; border-bottom: 2px dashed #f0f0f0; margin-bottom: 12px; }
        .j-date-box { display: flex; align-items: baseline; gap: 6px; color: var(--primary); }
        .j-day { font-size: 2rem; font-weight: 900; line-height: 1; }
        .j-ym { font-size: 0.9rem; font-weight: bold; color: var(--text-light); }
        .j-writer-badge { font-size: 0.8rem; padding: 4px 12px; border-radius: 12px; font-weight: bold; color: var(--text); opacity: 0.8; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .journal-content { line-height: 1.7; color: var(--text); white-space: pre-wrap; font-size: 1rem; font-weight: 500;}

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--primary); font-weight:bold; backdrop-filter: blur(5px); }
        
        .flight-edit-block .row { align-items: center; }
        .tz-select { padding: 0 10px; border: none; background: #E2E8F0; border-radius: var(--radius-S); font-weight: bold; color: var(--text); flex-shrink: 0; width: auto; height: 48px;}
    </style>
</head>
<body>

    <!-- SVG Sprites -->
    <svg style="display:none;">
        <symbol id="icon-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
        <symbol id="icon-book" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></symbol>
        <symbol id="icon-nav-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></symbol>
        <symbol id="icon-nav-cal" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></symbol>
        <symbol id="icon-nav-money" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></symbol>
        <symbol id="icon-nav-shop" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></symbol>
        <symbol id="icon-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-phone" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></symbol>
        <symbol id="icon-note" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></symbol>
        <symbol id="icon-map-pin" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></symbol>
        <symbol id="icon-plane-real" viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"></path></symbol>
        <symbol id="icon-house" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-ticket" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="2"></circle><path d="M6 12h.01M18 12h.01"></path></symbol>
        <symbol id="icon-car" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"></path></symbol>
        <symbol id="icon-spot" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol id="icon-food" viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></symbol>
        <symbol id="icon-transport" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="21" x2="8" y2="21.01"></line><line x1="16" y1="21" x2="16" y2="21.01"></line><line x1="3" y1="10" x2="21" y2="10"></line><path d="M8 15h.01"></path><path d="M16 15h.01"></path></symbol>
        <symbol id="icon-star" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></symbol>
        <symbol id="icon-rain" viewBox="0 0 24 24"><line x1="16" y1="13" x2="16" y2="21"></line><line x1="8" y1="13" x2="8" y2="21"></line><line x1="12" y1="15" x2="12" y2="23"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path></symbol>
        <symbol id="icon-cloud" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></symbol>
        <symbol id="icon-user" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></symbol>
        <symbol id="icon-camera" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></symbol>
        <symbol id="icon-chart-bar" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></symbol>
    </svg>

    <div id="loading-overlay" class="hidden">ÂêåÊ≠•‰∏≠...</div>

    <!-- 1. Home -->
    <div id="view-home">
        <div style="text-align:center; padding-top:80px; padding-bottom:30px;">
            <div style="font-size:3rem; margin-bottom:10px;">‚òÅÔ∏è</div>
            <h1 style="color:var(--primary-dark); margin:0; font-size:2rem; letter-spacing:1px;">ÊóÖÈÅäÊâãÂ∏≥</h1>
            <!-- Update #4: Team -> Version -->
            <p style="color:var(--text-light); font-size:0.9rem; margin-top:5px;">Version 7.3</p>
        </div>
        <div class="container" style="padding-bottom:20px;">
            <div class="card" style="padding:15px; display:flex; gap:10px;">
                <input type="text" id="join-trip-id" placeholder="Ëº∏ÂÖ•ÊóÖÁ®ã ID Âä†ÂÖ•..." style="margin:0;">
                <button class="btn btn-primary" onclick="window.joinTrip()" style="width:auto; padding:0 15px;">Âä†ÂÖ•</button>
            </div>
        </div>
        <div id="trip-list-container" class="container"></div>
        <button class="fab" onclick="window.openCreateTripModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
    </div>

    <!-- 2. Detail -->
    <div id="view-detail" class="hidden">
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="window.switchTab('info')"><svg class="icon-svg"><use href="#icon-nav-info"/></svg> Ë°åÂâç</button>
            <button class="nav-item" onclick="window.switchTab('itinerary')"><svg class="icon-svg"><use href="#icon-nav-cal"/></svg> Ë°åÁ®ã</button>
            <button class="nav-item" onclick="window.switchTab('money')"><svg class="icon-svg"><use href="#icon-nav-money"/></svg> Ë®òÂ∏≥</button>
            <button class="nav-item" onclick="window.switchTab('shopping')"><svg class="icon-svg"><use href="#icon-nav-shop"/></svg> Ê∏ÖÂñÆ</button>
            <button class="nav-item" onclick="window.switchTab('journal')"><svg class="icon-svg"><use href="#icon-book"/></svg> Êó•Ë™å</button>
        </nav>

        <!-- A. Info -->
        <div id="tab-info" class="tab-content">
            <div class="sticky-header">
                <div class="header-top">
                    <button class="back-btn btn-ghost" onclick="window.goHome()">‚óÄ ÂàóË°®</button>
                    <div class="header-title" id="header-trip-name-info"></div>
                    <button class="btn-ghost" onclick="window.shareTrip()"><svg class="icon-svg"><use href="#icon-share"/></svg></button>
                </div>
                <div class="sub-nav">
                    <button class="sub-nav-btn active" onclick="window.switchInfoSub('flight')">Ê©üÁ•®</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('hotel')">‰ΩèÂÆø</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('ticket')">ÈñÄÁ•®</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('charter')">ÂåÖËªä</button>
                    <button class="sub-nav-btn" onclick="window.switchInfoSub('packing')">Ë°åÊùé</button>
                </div>
            </div>
            <div class="container">
                <div id="info-flight" class="info-sub-tab">
                    <div id="countdown-area" class="countdown-banner hidden">
                        <div class="countdown-label" id="countdown-txt"></div>
                        <div class="countdown-num" id="countdown-val"></div>
                    </div>
                    <!-- Flights -->
                    <div class="card">
                        <div class="card-header"><svg class="icon-svg"><use href="#icon-plane-real"></use></svg> ÂéªÁ®ã Outbound</div>
                        <div class="flight-edit-block">
                            <span class="card-label">Ëà™Áè≠Ëôü / Ëà™Á©∫</span>
                            <div class="row"><div class="col"><input placeholder="Ëà™Áè≠Ëôü" id="f-out-code" oninput="window.saveFlight('out', 'code', this.value)"></div><div class="col"><input placeholder="Ëà™Á©∫ÂÖ¨Âè∏" id="f-out-airline" oninput="window.saveFlight('out', 'airline', this.value)"></div></div>
                            <span class="card-label">Ëµ∑È£õ</span>
                            <div class="row"><div class="col"><input type="time" id="f-out-depTime" oninput="window.saveFlight('out', 'depTime', this.value)"></div><select class="tz-select" id="f-out-depTz" onchange="window.saveFlight('out', 'depTz', this.value)"><option value="8">UTC+8</option><option value="9">UTC+9</option></select><div class="col"><input placeholder="Ê©üÂ†¥(TPE)" id="f-out-depAir" oninput="window.saveFlight('out', 'depAir', this.value)"></div></div>
                            <span class="card-label">ÈôçËêΩ</span>
                            <div class="row"><div class="col"><input type="time" id="f-out-arrTime" oninput="window.saveFlight('out', 'arrTime', this.value)"></div><select class="tz-select" id="f-out-arrTz" onchange="window.saveFlight('out', 'arrTz', this.value)"><option value="8">UTC+8</option><option value="9" selected>UTC+9</option></select><div class="col"><input placeholder="Ê©üÂ†¥(NRT)" id="f-out-arrAir" oninput="window.saveFlight('out', 'arrAir', this.value)"></div></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><svg class="icon-svg" style="transform: rotate(180deg);"><use href="#icon-plane-real"></use></svg> ÂõûÁ®ã Inbound</div>
                        <div class="flight-edit-block">
                            <span class="card-label">Ëà™Áè≠Ëôü / Ëà™Á©∫</span>
                            <div class="row"><div class="col"><input placeholder="Ëà™Áè≠Ëôü" id="f-in-code" oninput="window.saveFlight('in', 'code', this.value)"></div><div class="col"><input placeholder="Ëà™Á©∫ÂÖ¨Âè∏" id="f-in-airline" oninput="window.saveFlight('in', 'airline', this.value)"></div></div>
                            <span class="card-label">Ëµ∑È£õ</span>
                            <div class="row"><div class="col"><input type="time" id="f-in-depTime" oninput="window.saveFlight('in', 'depTime', this.value)"></div><select class="tz-select" id="f-in-depTz" onchange="window.saveFlight('in', 'depTz', this.value)"><option value="9" selected>UTC+9</option><option value="8">UTC+8</option></select><div class="col"><input placeholder="Ê©üÂ†¥(NRT)" id="f-in-depAir" oninput="window.saveFlight('in', 'depAir', this.value)"></div></div>
                            <span class="card-label">ÈôçËêΩ</span>
                            <div class="row"><div class="col"><input type="time" id="f-in-arrTime" oninput="window.saveFlight('in', 'arrTime', this.value)"></div><select class="tz-select" id="f-in-arrTz" onchange="window.saveFlight('in', 'arrTz', this.value)"><option value="8">UTC+8</option><option value="9">UTC+9</option></select><div class="col"><input placeholder="Ê©üÂ†¥(TPE)" id="f-in-arrAir" oninput="window.saveFlight('in', 'arrAir', this.value)"></div></div>
                        </div>
                    </div>
                </div>
                <div id="info-hotel" class="info-sub-tab hidden"><div id="hotel-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openHotelModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢û‰ΩèÂÆø</button></div>
                <div id="info-ticket" class="info-sub-tab hidden"><div id="ticket-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openTicketModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢ûÁ•®Âà∏</button></div>
                <div id="info-charter" class="info-sub-tab hidden"><div id="charter-list"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.openCharterModal()"><svg class="icon-svg icon-sm"><use href="#icon-plus"></use></svg> Êñ∞Â¢ûÂåÖËªä/Êé•ÈÄÅ</button></div>
                <div id="info-packing" class="info-sub-tab hidden">
                    <div class="card">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="pack-input" placeholder="Êñ∞Â¢ûÂÖ±Áî®Áâ©ÂìÅ..." style="margin:0;">
                            <button class="btn btn-primary" style="width:auto;" onclick="window.addPackItem()">Ôºã</button>
                        </div>
                        <div id="list-packing" style="margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B. Itinerary -->
        <div id="tab-itinerary" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">‚óÄ</button><div class="header-title" id="header-trip-name-itinerary"></div><div style="width:30px;"></div></div>
                <div class="day-scroller" id="day-tabs-itinerary"></div>
            </div>
            <div class="container">
                <div class="weather-card">
                    <div class="w-top-row">
                        <div class="w-loc-group"><div class="w-city" id="weather-loc">Loading...</div><div class="w-desc"><span id="weather-icon-box"></span><span id="weather-text">--</span></div></div>
                        <div class="w-main-temp"><span id="weather-temp">--</span>¬∞</div>
                    </div>
                    <div class="w-grid">
                        <div class="w-stat"><div class="w-stat-label">ÊúÄÈ´ò/‰Ωé</div><div class="w-stat-val"><span id="w-max">--</span>¬∞ / <span id="w-min">--</span>¬∞</div></div>
                        <div class="w-stat"><div class="w-stat-label">ÈôçÈõ®Áéá</div><div class="w-stat-val" style="color:#4299E1;"><span id="w-rain">--</span>%</div></div>
                        <div class="w-stat"><div class="w-stat-label">Êó•Âá∫/ËêΩ</div><div class="w-stat-val" style="font-size:0.8rem;"><span id="w-rise">--</span> | <span id="w-set">--</span></div></div>
                    </div>
                </div>
                <div id="flight-card-container"></div>
                <div class="timeline-wrapper"><div class="timeline-line"></div><div id="list-itinerary"></div></div>
                <div id="night-stay-container"></div>
            </div>
            <button class="fab" onclick="window.openNewItinerary()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>

        <!-- C. Money -->
        <div id="tab-money" class="tab-content hidden">
            <div style="background:var(--primary); padding:20px; border-radius:0 0 30px 30px; margin-top:-2px; color:white; box-shadow:0 10px 20px rgba(127,169,190,0.2);">
                <div style="text-align:center; font-size:0.9rem; opacity:0.8;">ÂåØÁéáÊèõÁÆó (NTD)</div>
                <div style="font-size:2rem; font-weight:900; text-align:center; margin:5px 0;" id="rate-display">0.0</div>
                <div class="row" style="justify-content:center; align-items:center; margin-bottom:0;">
                    <input type="number" id="rate-amount" placeholder="ÈáëÈ°ç" style="width:100px; text-align:center; background:white; color:black; border:none; margin:0;" oninput="window.updateRateCalc()">
                    <select id="rate-currency" style="background:rgba(255,255,255,0.2); border:none; color:white; font-weight:bold; border-radius:12px; padding:8px; width:auto; margin:0;" onchange="window.fetchRate()">
                        <option value="JPY">JPY</option><option value="USD">USD</option><option value="KRW">KRW</option><option value="EUR">EUR</option><option value="THB">THB</option><option value="CNY">CNY</option>
                    </select>
                </div>
            </div>
            <div class="sticky-header" style="top:0; border-bottom:none; background:transparent;">
                <div class="sub-nav" style="justify-content:center; padding-top:15px;">
                    <button class="sub-nav-btn active" id="btn-money-list" onclick="window.switchMoneySub('list')">ÂàóË°®</button>
                    <button class="sub-nav-btn" id="btn-money-analysis" onclick="window.switchMoneySub('analysis')">Áµ±Ë®à</button>
                </div>
            </div>
            <div class="container">
                <div id="money-view-list">
                    <div class="day-scroller" id="day-tabs-money"></div>
                    <div style="text-align:right; margin-bottom:10px; font-weight:bold; color:var(--text-light);">Áï∂Êó•: <span style="color:var(--primary); font-size:1.1rem;" id="day-total-display">$0</span></div>
                    <div id="list-money"></div>
                </div>
                <div id="money-view-analysis" class="hidden"><div id="analysis-content"></div></div>
            </div>
            <button class="fab" onclick="window.openMoneyModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>

        <!-- D. Lists -->
        <div id="tab-shopping" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">‚óÄ</button><div class="header-title">Ê∏ÖÂñÆ</div><div style="width:30px;"></div></div>
                <div class="sub-nav" style="justify-content:center;">
                    <button class="sub-nav-btn active" onclick="window.switchListSub('shop')">Ë≥ºÁâ©</button>
                    <button class="sub-nav-btn" onclick="window.switchListSub('food')">ÁæéÈ£ü</button>
                </div>
            </div>
            <div class="container">
                <div class="card">
                    <div style="display:flex; gap:10px; margin-bottom:12px;">
                        <input type="text" id="shop-input" placeholder="ÂêçÁ®±..." style="margin:0;">
                        <select id="shop-owner" style="width:90px; margin:0; padding:0 10px; flex-shrink:0;"></select>
                    </div>
                    <div class="row" style="margin-bottom:12px;">
                        <div class="col"><input type="text" id="shop-price" placeholder="È†êÁÆó" style="margin:0;"></div>
                        <div class="col"><input type="text" id="shop-loc" placeholder="Âú∞Èªû" style="margin:0;"></div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; align-items:center;">
                        <button class="btn btn-primary" style="width:auto; padding:10px 25px;" onclick="window.addListItem()">Êñ∞Â¢û</button>
                    </div>
                </div>
                <div id="list-items-container"></div>
            </div>
        </div>

        <!-- E. Journal -->
        <div id="tab-journal" class="tab-content hidden">
            <div class="sticky-header">
                <div class="header-top"><button class="back-btn btn-ghost" onclick="window.goHome()">‚óÄ</button><div class="header-title">Êó•Ë™å</div><div style="width:30px;"></div></div>
            </div>
            <div class="container" id="journal-list"></div>
            <button class="fab" onclick="window.openJournalModal()"><svg class="icon-svg"><use href="#icon-plus"/></svg></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-create-trip" class="modal hidden">
        <div class="modal-content">
            <h3>‚ú® Âª∫Á´ãÊñ∞ÊóÖÁ®ã</h3>
            <div class="input-group"><span class="card-label">ÂêçÁ®±</span><input type="text" id="new-trip-name"></div>
            <div class="input-group"><span class="card-label">ÂüéÂ∏Ç (Ëã±Êñá, Áî®ÊñºÂ§©Ê∞£)</span><input type="text" id="new-trip-city" placeholder="e.g. Tokyo"></div>
            <div class="row">
                <div class="col"><span class="card-label">Êó•Êúü</span><input type="date" id="new-trip-date"></div>
                <div class="col"><span class="card-label">Â§©Êï∏</span><input type="number" id="new-trip-days" value="5"></div>
            </div>
            <div class="input-group"><span class="card-label">ÊàêÂì° (ÈÄóËôüÈöîÈñã)</span><input type="text" id="new-trip-members" placeholder="Êàë, Amy, Bob"></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('create-trip')">ÂèñÊ∂à</button></div><div class="col"><button class="btn btn-primary" onclick="window.createNewTrip()">Âª∫Á´ã</button></div></div>
        </div>
    </div>

    <div id="modal-journal" class="modal hidden">
        <div class="modal-content">
            <h3>üìù ÂØ´Êó•Ë™å</h3>
            <div class="row">
                <div class="col"><span class="card-label">Êó•Êúü</span><input type="date" id="j-date"></div>
                <div class="col"><span class="card-label">Êí∞ÂØ´‰∫∫</span><select id="j-writer" style="padding:0 14px;"></select></div>
            </div>
            <div class="input-group"><span class="card-label">ÂÖßÂÆπ</span><textarea id="j-content" placeholder="‰ªäÂ§©ÁôºÁîü‰∫Ü‰ªÄÈ∫ºÊúâË∂£ÁöÑ‰∫ã..." style="height:150px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('journal')">ÂèñÊ∂à</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveJournal()">ÂÑ≤Â≠ò</button></div></div>
        </div>
    </div>

    <div id="modal-hotel" class="modal hidden">
        <div class="modal-content">
            <h3>‰ΩèÂÆø</h3>
            <div class="input-group"><span class="card-label">È£ØÂ∫óÂêçÁ®±</span><input id="h-name"></div>
            <div class="input-group"><span class="card-label">Âú∞ÂùÄ</span><input id="h-address"></div>
            <div class="row">
                <div class="col"><span class="card-label">Ë®ÇÊàøÁ∂≤</span><input id="h-source" placeholder="Agoda"></div>
                <div class="col"><span class="card-label">Ë®ÇÂñÆÁ∑®Ëôü</span><input id="h-order"></div>
            </div>
            <div class="row">
                <div class="col"><span class="card-label">ÂÖ•‰ΩèÊó•Êúü</span><input type="date" id="h-date"></div>
                <div class="col"><span class="card-label">ÂπæÊôö</span><input type="number" id="h-days" value="1"></div>
            </div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('hotel')">ÂèñÊ∂à</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveHotel()">ÂÑ≤Â≠ò</button></div></div>
        </div>
    </div>

    <div id="modal-ticket" class="modal hidden">
        <div class="modal-content">
            <h3>Á•®Âà∏</h3>
            <div class="input-group"><span class="card-label">ÂêçÁ®±</span><input id="t-name"></div>
            <div class="row">
                <div class="col"><span class="card-label">Êó•Êúü</span><input type="date" id="t-date"></div>
                <div class="col"><span class="card-label">Ë®ÇÂñÆÁ∑®Ëôü</span><input id="t-order"></div>
            </div>
            <div class="input-group"><span class="card-label">ÂÇôË®ª</span><textarea id="t-note" style="height:80px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('ticket')">ÂèñÊ∂à</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveTicket()">ÂÑ≤Â≠ò</button></div></div>
        </div>
    </div>
    
    <div id="modal-charter" class="modal hidden">
        <div class="modal-content">
            <h3>ÂåÖËªä / Êé•ÈÄÅ</h3>
            <div class="chip-group" style="margin-bottom:20px; justify-content:center;">
                <button class="chip-btn active" onclick="window.setCharterType(this, 'Êé•ÈÄÅ')">Êé•ÈÄÅ</button>
                <button class="chip-btn" onclick="window.setCharterType(this, 'ÂåÖËªä')">ÂåÖËªä</button>
            </div>
            <div class="row">
                <div class="col"><span class="card-label">Êó•Êúü</span><input type="date" id="c-date"></div>
                <div class="col"><span class="card-label">ÊôÇÈñì</span><input type="time" id="c-time"></div>
            </div>
            <div class="input-group"><span class="card-label">Êé•ÈÄÅÈªû</span><input id="c-from"></div>
            <div class="input-group"><span class="card-label">ÁõÆÁöÑÂú∞</span><input id="c-to"></div>
            <div class="input-group"><span class="card-label">ËÅØÁµ°Ë≥áË®ä</span><input id="c-contact"></div>
            <div class="input-group"><span class="card-label">ÂÇôË®ª</span><textarea id="c-note" style="height:60px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;"><div class="col"><button class="btn" onclick="window.closeModal('charter')">ÂèñÊ∂à</button></div><div class="col"><button class="btn btn-primary" onclick="window.saveCharter()">ÂÑ≤Â≠ò</button></div></div>
        </div>
    </div>

    <div id="modal-money" class="modal hidden">
        <div class="modal-content">
            <h3>Ë®òÂ∏≥</h3>
            <div class="row">
                <div class="col"><span class="card-label">Êó•Êúü</span><input type="date" id="m-date"></div>
            </div>
            <div class="input-group"><span class="card-label">È†ÖÁõÆ</span><input id="m-title"></div>
            <div class="row">
                <div style="width:90px;"><span class="card-label">Âπ£Âà•</span><select id="m-curr" style="padding:0 14px;"><option value="NT$">NT$</option><option value="¬•">¬•</option><option value="‚Ç©">‚Ç©</option></select></div>
                <div class="col"><span class="card-label">ÈáëÈ°ç</span><input type="number" id="m-cost"></div>
            </div>
            <span class="card-label">‰ªòÊ¨æ‰∫∫</span>
            <div id="m-payer-wrapper" class="chip-group" style="margin-bottom:20px;"></div>
            <span class="card-label">ÊñπÂºè</span>
            <div class="chip-group">
                <button class="chip-btn method-btn" onclick="window.setMoneyMethod('cash', this)">ÁèæÈáë</button>
                <button class="chip-btn method-btn" onclick="window.setMoneyMethod('card', this)">‰ø°Áî®Âç°</button>
                <button class="chip-btn method-btn" onclick="window.setMoneyMethod('other', this)">ÂÖ∂‰ªñ</button>
            </div>
            <div class="row" style="margin-top:25px; gap:10px;">
                <button class="btn" id="btn-delete-money" onclick="window.deleteMoneyItemInModal()" style="background:#FFF5F5; color:var(--accent); width:50px; flex:none; display:none;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                <div class="col"><button class="btn" onclick="window.closeModal('money')">ÂèñÊ∂à</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveMoney()">ÂÑ≤Â≠ò</button></div>
            </div>
        </div>
    </div>
    
    <div id="modal-itinerary" class="modal hidden">
        <div class="modal-content">
            <h3>Ë°åÁ®ã</h3>
            <div class="input-group"><span class="card-label">È°ûÂà•</span>
                <select id="i-type" style="padding:0 14px;">
                    <option value="spot">üìç ÊôØÈªû</option><option value="food">üçΩÔ∏è ÁæéÈ£ü</option><option value="shop">üõçÔ∏è Ë≥ºÁâ©</option><option value="transport">üöã ‰∫§ÈÄö</option><option value="other">‚ú® ÂÖ∂‰ªñ</option>
                </select>
            </div>
            <div class="row">
                <div class="col"><span class="card-label" id="label-time-start">ÈñãÂßãÊôÇÈñì</span><input type="time" id="i-time"></div>
                <div class="col hidden" id="wrapper-end-time"><span class="card-label">ÊäµÈÅîÊôÇÈñì</span><input type="time" id="i-end-time"></div>
            </div>
            <div class="input-group" style="position:relative;">
                <span class="card-label">Âú∞Èªû / ÂêçÁ®±</span>
                <input type="text" id="i-loc" placeholder="Google Maps Âú∞Èªû">
                <div style="position:absolute; right:12px; bottom:12px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            <div class="input-group hidden" id="wrapper-dest" style="position:relative;">
                <span class="card-label">ÁõÆÁöÑÂú∞</span>
                <input type="text" id="i-dest">
                <div style="position:absolute; right:12px; bottom:12px; color:var(--primary);"><svg class="icon-svg icon-sm"><use href="#icon-pin"></use></svg></div>
            </div>
            <div class="input-group hidden" id="wrapper-title"><span class="card-label">Ë£úÂÖÖÊ®ôÈ°å (ÈÅ∏Â°´)</span><input type="text" id="i-title" placeholder="Â¶Ç: JRÂ±±ÊâãÁ∑ö"></div>
            <div class="input-group hidden" id="wrapper-open"><span class="card-label">ÁáüÊ•≠ÊôÇÈñì (ÈÅ∏Â°´)</span><input type="text" id="i-open"></div>
            <div class="input-group"><span class="card-label">ÂÇôË®ª</span><textarea id="i-note" style="height:80px;"></textarea></div>
            <div class="row" style="margin-top:20px; gap:10px;">
                <button class="btn" onclick="window.deleteItineraryItemInModal()" style="background:#FFF5F5; color:var(--accent); width:50px; flex:none;"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                <div class="col"><button class="btn" onclick="window.closeModal('itinerary')">ÂèñÊ∂à</button></div>
                <div class="col"><button class="btn btn-primary" onclick="window.saveItinerary()">ÂÑ≤Â≠ò</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // 1. Firebase Config (Replace with your own keys)
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyCU3D_Grf3fN3uI3qt5hwWugieBke_Nq94",
             authDomain: "travel-4638f.firebaseapp.com",
             projectId: "travel-4638f",
             storageBucket: "travel-4638f.firebasestorage.app",
             messagingSenderId: "812351265932",
             appId: "1:812351265932:web:71b3ddc475501f571b2fa9",
             measurementId: "G-4M3N10PR26"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { console.error("FB Init Fail", e); }

        // ---------------------------------------------------------
        // 2. Logic
        // ---------------------------------------------------------
        let currentTrip = null;
        let unsubscribe = null;
        let appState = { dayIdx: 0, editId: null, editType: null, listType: 'shop', charterType:'Êé•ÈÄÅ' };
        let moneyState = { payer: '', method: 'cash' };
        let currentRate = 0.22;
        let currentInfoTab = 'flight';

        window.openCreateTripModal = function() {
            document.getElementById('new-trip-name').value = '';
            document.getElementById('new-trip-city').value = '';
            document.getElementById('new-trip-date').value = '';
            document.getElementById('new-trip-members').value = '';
            document.getElementById('new-trip-days').value = '5';
            window.openModal('create-trip');
        };

        function fillMemberSelect(selectId) {
            const el = document.getElementById(selectId);
            if(!el || !currentTrip) return;
            el.innerHTML = '';
            currentTrip.members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                el.appendChild(opt);
            });
        }

        window.renderHome = function() {
            document.getElementById('view-home').classList.remove('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            const list = document.getElementById('trip-list-container');
            const savedIds = JSON.parse(localStorage.getItem('tl_ids') || '[]');
            const savedMetas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
            list.innerHTML = savedIds.length ? '' : '<div style="text-align:center; color:#CCC; margin-top:20px;">ÁÑ°Á¥ÄÈåÑ</div>';
            savedIds.forEach(id => {
                const meta = savedMetas[id] || {name:'Trip', date:'-'};
                list.innerHTML += `
                    <div class="card" onclick="window.openTrip('${id}')">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${meta.name}</div>
                                <div style="font-size:0.8rem; color:#999;">${meta.date}</div>
                            </div>
                            <button class="btn-del" onclick="event.stopPropagation(); window.deleteTrip('${id}')"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                        </div>
                    </div>`;
            });
        };

        window.deleteTrip = async function(id) {
            if(!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ÊóÖÁ®ãÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ")) return;
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "trips", id));
                let ids = JSON.parse(localStorage.getItem('tl_ids') || '[]');
                ids = ids.filter(x => x !== id);
                localStorage.setItem('tl_ids', JSON.stringify(ids));
                let metas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
                delete metas[id];
                localStorage.setItem('tl_metas', JSON.stringify(metas));
                window.renderHome();
            } catch(e) { alert("Âà™Èô§Â§±Êïó: " + e.message); }
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        window.createNewTrip = async function() {
            const name = document.getElementById('new-trip-name').value;
            const city = document.getElementById('new-trip-city').value;
            const date = document.getElementById('new-trip-date').value;
            if(!name || !date) return alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥');
            const id = Date.now().toString();
            const newTrip = {
                id, name, city, startDate: date,
                days: parseInt(document.getElementById('new-trip-days').value) || 1,
                members: document.getElementById('new-trip-members').value.split(/[,Ôºå\s]+/).filter(Boolean),
                itinerary: [], money: [], shopping: [], foodList: [], packing: [], journals: [],
                flights: { out:{depTz:8, arrTz:9}, in:{depTz:9, arrTz:8} }, hotels: [], tickets: [], charters: []
            };
            if(newTrip.members.length===0) newTrip.members=['Êàë'];
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                await setDoc(doc(db, "trips", id), newTrip);
                saveLocal(id, name, date);
                document.getElementById('loading-overlay').classList.add('hidden');
                window.closeModal('create-trip');
                window.openTrip(id);
            } catch (e) {
                alert("Âª∫Á´ãÂ§±Êïó: " + e.message);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        };

        window.joinTrip = async function() {
            const id = document.getElementById('join-trip-id').value.trim();
            if(!id) return;
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const snap = await getDoc(doc(db, "trips", id));
                if(snap.exists()) {
                    const d = snap.data();
                    saveLocal(id, d.name, d.startDate);
                    window.openTrip(id);
                } else alert('Êâæ‰∏çÂà∞Ê≠§ ID');
            } catch(e) { alert("ËÆÄÂèñÂ§±Êïó: "+e.message); }
            document.getElementById('loading-overlay').classList.add('hidden');
        };

        function saveLocal(id, name, date) {
            let ids = JSON.parse(localStorage.getItem('tl_ids') || '[]');
            if(!ids.includes(id)) ids.unshift(id);
            localStorage.setItem('tl_ids', JSON.stringify(ids));
            let metas = JSON.parse(localStorage.getItem('tl_metas') || '{}');
            metas[id] = {name, date};
            localStorage.setItem('tl_metas', JSON.stringify(metas));
        }

        window.openTrip = function(id) {
            if(unsubscribe) unsubscribe();
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
            unsubscribe = onSnapshot(doc(db, "trips", id), (doc) => {
                if(doc.exists()) {
                    currentTrip = doc.data();
                    if(!currentTrip.journals) currentTrip.journals = [];
                    if(!currentTrip.foodList) currentTrip.foodList = [];
                    if(!currentTrip.flights) currentTrip.flights = { out:{}, in:{} };
                    if(!currentTrip.itinerary) currentTrip.itinerary = [];
                    
                    document.getElementById('header-trip-name-info').innerText = currentTrip.name;
                    document.getElementById('header-trip-name-itinerary').innerText = currentTrip.name;
                    
                    const activeTabId = document.querySelector('.nav-item.active').getAttribute('onclick').match(/'([^']+)'/)[1];
                    if(activeTabId === 'itinerary') window.renderAllDetail();
                    else if(activeTabId === 'money') { window.renderMoney(); window.renderMoneyAnalysis(); }
                    else if(activeTabId === 'info') { 
                        window.fillFlightInputs(); 
                        window.updateCountdown(); 
                        window.switchInfoSub(currentInfoTab); 
                    }
                    else if(activeTabId === 'shopping') window.renderLists();
                    else if(activeTabId === 'journal') window.renderJournal();
                }
            });
            appState.dayIdx = 0;
            window.switchTab('info');
            window.updateCountdown();
            window.fetchRate();
        };

        window.saveData = async function() {
            if(currentTrip) await updateDoc(doc(db, "trips", currentTrip.id), currentTrip);
        };

        window.switchTab = function(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            const map = {info:0, itinerary:1, money:2, shopping:3, journal:4};
            document.querySelectorAll('.nav-item')[map[t]].classList.add('active');
            
            if(t==='journal') window.renderJournal();
            if(t==='shopping') { fillMemberSelect('shop-owner'); window.renderLists(); }
            if(t==='itinerary') {
                setTimeout(() => window.renderAllDetail(), 50); 
            }
        };

        window.switchInfoSub = function(sub) {
            currentInfoTab = sub;
            document.querySelectorAll('.info-sub-tab').forEach(e=>e.classList.add('hidden'));
            document.getElementById('info-'+sub).classList.remove('hidden');
            document.querySelectorAll('#tab-info .sub-nav-btn').forEach(e=>e.classList.remove('active'));
            const map = {flight:0, hotel:1, ticket:2, charter:3, packing:4};
            if(document.querySelectorAll('#tab-info .sub-nav-btn')[map[sub]])
                document.querySelectorAll('#tab-info .sub-nav-btn')[map[sub]].classList.add('active');
            
            if(sub==='packing') { window.renderPacking(); fillMemberSelect('pack-owner'); }
            if(sub==='flight') window.updateCountdown();
            if(sub==='hotel') window.renderHotels();
            if(sub==='ticket') window.renderTickets();
            if(sub==='charter') window.renderCharters();
        };

        // --- Modals & Saving Logic ---
        window.openModal = function(id) { document.getElementById('modal-'+id).classList.remove('hidden'); };
        window.closeModal = function(id) { document.getElementById('modal-'+id).classList.add('hidden'); };
        function v(id) { return document.getElementById(id).value; }
        
        function saveItem(arrName, data) {
            const id = appState.editId || Date.now();
            const newItem = { id, ...data };
            if(appState.editId) {
                const idx = currentTrip[arrName].findIndex(x=>x.id===appState.editId);
                if(idx!==-1) currentTrip[arrName][idx] = newItem;
            } else currentTrip[arrName].push(newItem);
            window.saveData(); window.closeModal(appState.editType);
        }
        function resetModal(type, id) {
            const map = { hotel: ['h-name','h-address','h-source','h-order','h-date','h-days'], ticket: ['t-name','t-date','t-order','t-note'], charter: ['c-date','c-time','c-from','c-to','c-contact','c-note'] };
            if(id) { const item = currentTrip[type+'s'].find(x=>x.id===id); map[type].forEach(k => document.getElementById(k).value = item[k.split('-')[1]] || ''); } 
            else { map[type].forEach(k => document.getElementById(k).value = ''); }
        }

        // --- Journal ---
        window.openJournalModal = function() {
            document.getElementById('j-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('j-content').value = '';
            fillMemberSelect('j-writer');
            window.openModal('journal');
        };
        window.saveJournal = function() {
            const date = document.getElementById('j-date').value;
            const writer = document.getElementById('j-writer').value;
            const content = document.getElementById('j-content').value;
            if(!content) return;
            currentTrip.journals.unshift({ id:Date.now(), date, writer, content }); // Use unshift to add to top
            // Force sort just in case
            currentTrip.journals.sort((a,b) => {
                if(a.date !== b.date) return b.date.localeCompare(a.date);
                return b.id - a.id;
            });
            window.saveData(); window.closeModal('journal');
        };
        function getPastelColor(str) {
            const colors = ['#FCA5A5', '#FDBA74', '#FDE047', '#86EFAC', '#67E8F9', '#93C5FD', '#C4B5FD', '#F9A8D4'];
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
        window.renderJournal = function() {
            const list = document.getElementById('journal-list'); list.innerHTML = '';
            if(!currentTrip.journals || currentTrip.journals.length===0) { list.innerHTML='<div style="text-align:center; color:#CCC; margin-top:20px;">ÈÇÑÊ≤íÊúâÊó•Ë™åÔºåÂØ´‰∏ÄÁØáÂêßÔºÅ</div>'; return; }
            
            // Ensure sorted newest first
            currentTrip.journals.sort((a,b) => {
                if(a.date !== b.date) return b.date.localeCompare(a.date);
                return b.id - a.id;
            });

            currentTrip.journals.forEach(j => {
                const d = new Date(j.date);
                const day = d.getDate();
                const ym = `${d.getFullYear()} Âπ¥ ${d.getMonth()+1} Êúà`;
                const bg = getPastelColor(j.writer || 'A');
                
                list.innerHTML += `
                <div class="journal-card">
                    <div class="journal-header">
                        <div class="j-date-box">
                            <span class="j-day">${day}</span>
                            <span class="j-ym">Êó• / ${ym}</span>
                        </div>
                        <div class="j-writer-badge" style="background:${bg}">${j.writer}</div>
                    </div>
                    <div class="journal-content">${j.content}</div>
                    <button class="btn-del" style="float:right; margin-top:15px; background:#f9f9f9;" onclick="window.delItem('journals', ${j.id})">Âà™Èô§</button>
                    <div style="clear:both;"></div>
                </div>`;
            });
        };

        // --- Packing (Optimized) ---
        window.addPackItem = function() {
            const val = document.getElementById('pack-input').value;
            if(!val) return;
            let checks = {};
            currentTrip.members.forEach(m => checks[m] = false);
            currentTrip.packing.push({ id:Date.now(), text:val, checks: checks });
            document.getElementById('pack-input').value = '';
            window.saveData();
        };
        window.toggleMemberCheck = function(itemId, member) {
            const item = currentTrip.packing.find(x => x.id === itemId);
            if(item) {
                if(!item.checks) item.checks = {};
                item.checks[member] = !item.checks[member];
                window.saveData();
            }
        };
        window.renderPacking = function() {
            const list = document.getElementById('list-packing'); list.innerHTML = '';
            currentTrip.packing.forEach(i => {
                let membersHtml = '<div class="packing-grid">';
                currentTrip.members.forEach(m => {
                    const isChecked = i.checks && i.checks[m];
                    membersHtml += `<div class="pack-member-chip ${isChecked?'checked':''}" onclick="window.toggleMemberCheck(${i.id}, '${m}')">${isChecked?'‚úì':''} ${m}</div>`;
                });
                membersHtml += '</div>';
                list.innerHTML += `<div class="card" style="padding:15px; margin-bottom:10px;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold; font-size:1.1rem;">${i.text}</span><button class="btn-ghost" onclick="window.delItem('packing', ${i.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"/></svg></button></div>${membersHtml}</div>`;
            });
        };

        // --- Lists (Shop/Food) ---
        window.switchListSub = function(t) { appState.listType=t; document.querySelectorAll('#tab-shopping .sub-nav-btn').forEach(b=>b.classList.toggle('active', (t==='shop'&&b.innerText.includes('Ë≥ºÁâ©'))||(t==='food'&&b.innerText.includes('ÁæéÈ£ü')))); fillMemberSelect('shop-owner'); window.renderLists(); };
        window.addListItem = function() {
            const inp = document.getElementById('shop-input');
            const owner = document.getElementById('shop-owner').value;
            const price = document.getElementById('shop-price').value;
            const loc = document.getElementById('shop-loc').value;
            if(!inp.value) return;
            const arr = appState.listType==='shop'?'shopping':'foodList';
            currentTrip[arr].push({
                id:Date.now(), text:inp.value, price, location:loc, owner, checked:false
            });
            inp.value=''; document.getElementById('shop-price').value=''; document.getElementById('shop-loc').value='';
            window.saveData();
        };
        window.renderLists = function() {
            const list = document.getElementById('list-items-container'); list.innerHTML = '';
            const arr = appState.listType==='shop'?'shopping':'foodList';
            (currentTrip[arr]||[]).forEach(i => {
                let pillPrice = i.price ? `<span class="meta-pill meta-price"><svg class="icon-svg"><use href="#icon-nav-money"/></svg>${i.price}</span>` : '';
                let pillLoc = i.location ? `<span class="meta-pill meta-loc"><svg class="icon-svg"><use href="#icon-map-pin"/></svg>${i.location}</span>` : '';
                let ownerHtml = i.owner ? `<div class="member-badge-pill">${i.owner}</div>` : '';

                // Update #3: Swapped Location and Price order
                list.innerHTML += `
                    <div class="card check-item ${i.checked?'checked':''}" onclick="window.toggleCheck('${arr}', ${i.id})">
                        <div class="check-left">
                            <div class="check-name-row">
                                <div class="check-box"></div>
                                <div class="check-text">${i.text}</div>
                            </div>
                            ${ (i.price || i.location) ? '<div class="check-separator"></div>' : '' }
                            <div class="check-meta-row">
                                ${pillLoc}
                                ${pillPrice}
                            </div>
                        </div>
                        <div class="check-right">
                            ${ownerHtml}
                            <button class="btn-list-del" onclick="event.stopPropagation(); window.delItem('${arr}', ${i.id})"><svg class="icon-svg icon-sm"><use href="#icon-trash"></use></svg></button>
                        </div>
                    </div>`;
            });
        };

        window.toggleCheck = function(arr, id) { const i=currentTrip[arr].find(x=>x.id===id); if(i){i.checked=!i.checked; window.saveData();} };
        window.delItem = function(arr, id) { if(confirm('Âà™Èô§Ôºü')){ currentTrip[arr]=currentTrip[arr].filter(x=>x.id!==id); window.saveData(); } };
        window.goHome = function() { 
            if(unsubscribe) unsubscribe();
            document.getElementById('view-home').classList.remove('hidden'); 
            document.getElementById('view-detail').classList.add('hidden'); 
            window.renderHome();
        };
        window.shareTrip = function() { navigator.clipboard.writeText(currentTrip.id).then(()=>alert("IDÂ∑≤Ë§áË£Ω: "+currentTrip.id)); };

        // --- Info: Flights/Hotels/Tickets/Charters ---
        function renderTimezoneOptions(selected) {
            let html = '';
            for(let i=-12; i<=14; i++) {
                const label = i >= 0 ? `UTC+${i}` : `UTC${i}`;
                html += `<option value="${i}" ${parseInt(selected)==i?'selected':''}>${label}</option>`;
            }
            return html;
        }

        window.fillFlightInputs = function() {
            if(!currentTrip) return;
            const f = currentTrip.flights;
            ['out','in'].forEach(dir => {
                document.getElementById(`f-${dir}-code`).value = f[dir].code || '';
                document.getElementById(`f-${dir}-airline`).value = f[dir].airline || '';
                document.getElementById(`f-${dir}-depTime`).value = f[dir].depTime || '';
                document.getElementById(`f-${dir}-depAir`).value = f[dir].depAir || '';
                document.getElementById(`f-${dir}-arrTime`).value = f[dir].arrTime || '';
                document.getElementById(`f-${dir}-arrAir`).value = f[dir].arrAir || '';
                
                // Dynamic Timezone
                document.getElementById(`f-${dir}-depTz`).innerHTML = renderTimezoneOptions(f[dir].depTz || (dir==='out'?8:9));
                document.getElementById(`f-${dir}-arrTz`).innerHTML = renderTimezoneOptions(f[dir].arrTz || (dir==='out'?9:8));
            });
        };
        window.saveFlight = function(dir, field, val) {
            currentTrip.flights[dir][field] = val; window.saveData();
        };
        
        window.updateCountdown = function() {
            if(!currentTrip) return;
            const today = new Date(); today.setHours(0,0,0,0);
            const start = new Date(currentTrip.startDate);
            const diff = Math.ceil((start - today) / (1000 * 60 * 60 * 24));
            
            const banner = document.getElementById('countdown-area');
            const txt = document.getElementById('countdown-txt');
            const num = document.getElementById('countdown-val');
            banner.classList.remove('hidden', 'ended');
            
            if(diff > 0) {
                txt.innerHTML = "Ë∑ùÈõ¢Âá∫ÁôºÈÇÑÂâ©‰∏ã";
                num.innerHTML = `${diff} <span style="font-size:1rem; font-weight:normal;">Â§©</span>`;
            } else if (diff <= 0 && diff >= -currentTrip.days) {
                txt.innerHTML = "ÊóÖÁ®ãÈÄ≤Ë°å‰∏≠";
                num.innerHTML = "Have Fun!";
            } else {
                banner.classList.add('ended');
                txt.innerHTML = "ÊóÖÁ®ãÂ∑≤ÁµêÊùü";
                num.innerHTML = "See you next time!";
            }
        };

        function calcDuration(t1, tz1, t2, tz2) {
            if(!t1 || !t2) return '';
            const getUtcMin = (time, tz) => {
                const [h, m] = time.split(':').map(Number);
                return (h * 60 + m) - (parseInt(tz) * 60);
            };
            const m1 = getUtcMin(t1, tz1||8);
            const m2 = getUtcMin(t2, tz2||8);
            let diff = m2 - m1;
            if (diff < 0) diff += 24 * 60; 
            const h = Math.floor(diff/60);
            const m = diff % 60;
            return `${h}h ${m}m`;
        }

        window.openHotelModal = function(id) { appState.editId=id; appState.editType='hotel'; resetModal('hotel', id); window.openModal('hotel'); };
        window.saveHotel = function() { saveItem('hotels', { name:v('h-name'), address:v('h-address'), source:v('h-source'), order:v('h-order'), date:v('h-date'), days:v('h-days') }); };
        window.renderHotels = function() { 
            const list = document.getElementById('hotel-list'); list.innerHTML = '';
            (currentTrip.hotels||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(h => {
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box"><svg class="icon-svg"><use href="#icon-house"></use></svg></div><div class="info-card-content"><div style="font-weight:bold;">${h.name}</div><div class="info-card-sub"><svg class="icon-svg icon-xs"><use href="#icon-nav-cal"></use></svg> ${h.date} (${h.days}Êôö)</div><div class="info-card-sub" style="color:var(--primary); font-weight:bold;">${h.source || ''} #${h.order || ''}</div></div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openHotelModal(${h.id})">‚úé</button><button class="btn-del" onclick="window.delItem('hotels', ${h.id})">‚úï</button></div></div>`;
            });
        };

        window.openTicketModal = function(id) { appState.editId=id; appState.editType='ticket'; resetModal('ticket', id); window.openModal('ticket'); };
        window.saveTicket = function() { saveItem('tickets', { name:v('t-name'), date:v('t-date'), order:v('t-order'), note:v('t-note') }); };
        window.renderTickets = function() { 
            const list = document.getElementById('ticket-list'); list.innerHTML = '';
            (currentTrip.tickets||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(t => {
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box" style="background:#FFF8E1; color:#FBC02D;"><svg class="icon-svg"><use href="#icon-ticket"></use></svg></div><div class="info-card-content"><div style="font-weight:bold;">${t.name}</div><div class="info-card-sub"><svg class="icon-svg icon-xs"><use href="#icon-nav-cal"></use></svg> ${t.date}</div><div class="info-card-sub" style="color:#666;">#${t.order||'ÁÑ°Á∑®Ëôü'}</div></div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openTicketModal(${t.id})">‚úé</button><button class="btn-del" onclick="window.delItem('tickets', ${t.id})">‚úï</button></div></div>`;
            });
        };

        window.openCharterModal = function(id) { 
            appState.editId = id; appState.editType='charter'; resetModal('charter', id); 
            if(id) { const c = currentTrip.charters.find(x=>x.id===id); appState.charterType=c.type; } else appState.charterType='Êé•ÈÄÅ';
            updateCharterBtns(); window.openModal('charter'); 
        };
        window.setCharterType = function(el, t) { appState.charterType=t; updateCharterBtns(); };
        function updateCharterBtns() { document.querySelectorAll('#modal-charter .chip-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(appState.charterType))); }
        window.saveCharter = function() { 
            saveItem('charters', { type:appState.charterType, date:v('c-date'), time:v('c-time'), from:v('c-from'), to:v('c-to'), contact:v('c-contact'), note:v('c-note') });
        };
        window.renderCharters = function() {
            const list = document.getElementById('charter-list'); list.innerHTML = '';
            (currentTrip.charters||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(c => {
                let noteHtml = c.note ? `<div class="note-row"><svg class="icon-svg"><use href="#icon-note"></use></svg> ${c.note}</div>` : '';
                let contactHtml = c.contact ? `<div class="note-row"><svg class="icon-svg"><use href="#icon-phone"></use></svg> ${c.contact}</div>` : '';
                list.innerHTML += `<div class="info-card-item"><div class="item-icon-box" style="background:#F3F0FF; color:#9F7AEA;"><svg class="icon-svg"><use href="#icon-car"></use></svg></div><div class="info-card-content"><div class="info-card-title" style="color:var(--primary); font-size:0.9rem;">${c.date} ${c.time}</div><div style="font-weight:bold;">${c.type}</div><div class="info-card-sub" style="font-weight:bold; color:var(--text);">${c.from} ‚ûù ${c.to}</div>${contactHtml}${noteHtml}</div><div style="flex-shrink:0;"><button class="btn-edit" onclick="window.openCharterModal(${c.id})">‚úé</button><button class="btn-del" onclick="window.delItem('charters', ${c.id})">‚úï</button></div></div>`;
            });
        };

        // --- Money ---
        window.openMoneyModal = function(id) {
            appState.editId = id; appState.editType='money';
            if(id) {
                const m = currentTrip.money.find(x=>x.id===id);
                document.getElementById('m-title').value = m.title;
                document.getElementById('m-cost').value = m.cost;
                document.getElementById('m-date').value = m.date;
                moneyState.payer = m.payer; moneyState.method = m.method;
            } else {
                ['m-title','m-cost'].forEach(k=>document.getElementById(k).value='');
                moneyState.payer = currentTrip.members[0]; moneyState.method='cash';
                const d = new Date(currentTrip.startDate); d.setDate(d.getDate() + appState.dayIdx);
                document.getElementById('m-date').value = d.toISOString().split('T')[0];
            }
            renderPayerBtns(); renderMethodBtns(); 
            // Delete button logic
            const delBtn = document.getElementById('btn-delete-money');
            if(id) delBtn.style.display = 'flex'; else delBtn.style.display = 'none';
            window.openModal('money');
        };
        
        window.deleteMoneyItemInModal = function() {
            if(!appState.editId) return;
            if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Á≠ÜÂ∏≥ÂãôÔºü')) {
                currentTrip.money = currentTrip.money.filter(x => x.id !== appState.editId);
                window.saveData();
                window.closeModal('money');
            }
        };

        function renderPayerBtns() {
            const c = document.getElementById('m-payer-wrapper'); c.innerHTML='';
            currentTrip.members.forEach(m => {
                const b = document.createElement('button'); b.className='chip-btn';
                b.innerText=m;
                if(moneyState.payer===m) b.classList.add('active');
                b.onclick = () => { moneyState.payer=m; renderPayerBtns(); };
                c.appendChild(b);
            });
        }
        function renderMethodBtns() {
            document.querySelectorAll('.method-btn').forEach(b => {
                b.classList.remove('active');
                const map={'ÁèæÈáë':'cash','‰ø°Áî®Âç°':'card','ÂÖ∂‰ªñ':'other'};
                if(map[b.innerText]===moneyState.method) b.classList.add('active');
            });
        }
        window.setMoneyMethod = function(m, el) { moneyState.method=m; renderMethodBtns(); };
        window.saveMoney = function() {
            saveItem('money', { dayIdx: appState.dayIdx, date: v('m-date'), title: v('m-title'), cost: parseFloat(v('m-cost')), curr: document.getElementById('m-curr').value, payer: moneyState.payer, method: moneyState.method });
        };
        window.renderMoney = function() {
            const list = document.getElementById('list-money'); list.innerHTML='';
            const items = (currentTrip.money||[]).filter(i=>i.dayIdx===appState.dayIdx);
            let totals = {}; items.forEach(i => { totals[i.curr] = (totals[i.curr]||0) + i.cost; });
            let tStr = Object.keys(totals).map(k=>`${k} ${totals[k].toLocaleString()}`).join(' ');
            document.getElementById('day-total-display').innerText = tStr || '$0';
            const methodMap = { 'cash': 'ÁèæÈáë', 'card': '‰ø°Áî®Âç°', 'other': 'ÂÖ∂‰ªñ' };
            
            items.reverse().forEach(i => {
                list.innerHTML += `
                <div class="money-item-row" onclick="window.openMoneyModal(${i.id})">
                    <div class="money-info">
                        <div class="money-title">${i.title}</div>
                        <div class="money-meta">
                            <span class="money-tag">${i.payer}</span>
                            <span>${methodMap[i.method]}</span>
                        </div>
                    </div>
                    <div class="money-amount">${i.curr} ${i.cost}</div>
                </div>`;
            });
        };
        window.switchMoneySub = function(sub) {
            document.getElementById('money-view-list').classList.toggle('hidden', sub!=='list');
            document.getElementById('money-view-analysis').classList.toggle('hidden', sub!=='analysis');
            document.getElementById('btn-money-list').classList.toggle('active', sub==='list');
            document.getElementById('btn-money-analysis').classList.toggle('active', sub==='analysis');
            if(sub==='analysis') window.renderMoneyAnalysis();
        };
        window.renderMoneyAnalysis = function() {
            const container = document.getElementById('analysis-content'); container.innerHTML = '';
            let stats = {}; let grandTotals = {}; 
            currentTrip.members.forEach(m => { stats[m] = {}; });
            currentTrip.money.forEach(m => {
                const p = m.payer || currentTrip.members[0]; const curr = m.curr || 'NT$'; const cost = parseFloat(m.cost);
                if (!stats[p]) stats[p] = {};
                stats[p][curr] = (stats[p][curr] || 0) + cost;
                grandTotals[curr] = (grandTotals[curr] || 0) + cost;
            });
            
            // Grand Totals Section
            let grandTotalHtml = '';
            Object.keys(grandTotals).forEach(c => {
                 grandTotalHtml += `<div style="display:flex; justify-content:space-between; font-size:1.1rem; font-weight:bold; padding:5px 0;"><span>${c}</span><span>${grandTotals[c].toLocaleString()}</span></div>`;
            });
            if(grandTotalHtml) {
                 container.innerHTML += `<div class="card" style="padding:15px; background:var(--primary-light); border-color:var(--primary);"><div style="font-weight:900; color:var(--primary-dark); margin-bottom:10px; display:flex; align-items:center; gap:5px;"><svg class="icon-svg"><use href="#icon-chart-bar"/></svg> Á∏ΩÊîØÂá∫‰∏ÄË¶Ω</div>${grandTotalHtml}</div>`;
            }

            Object.keys(stats).forEach(member => {
                let currencyHtml = '';
                Object.keys(stats[member]).forEach(c => { currencyHtml += `<div style="display:flex; justify-content:space-between;"><span>${c}</span><span>${stats[member][c].toLocaleString()}</span></div>`; });
                container.innerHTML += `<div class="card" style="padding:15px;"><div style="font-weight:bold; border-bottom:1px solid #eee; margin-bottom:5px;">${member}</div>${currencyHtml||'ÁÑ°'}</div>`;
            });
        };

        window.openMap = function(e, loc) { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`); };
        window.fetchRate = async function() {
            const curr = document.getElementById('rate-currency').value;
            try { const res = await fetch(`https://api.exchangerate-api.com/v4/latest/TWD`); const data = await res.json(); if(data.rates[curr]) { currentRate = 1/data.rates[curr]; window.updateRateCalc(); } } catch(e){}
        };
        window.updateRateCalc = function() {
            const amt = parseFloat(document.getElementById('rate-amount').value) || 0;
            document.getElementById('rate-display').innerText = amt===0 ? `1 : ${currentRate.toFixed(2)}` : `$${(amt*currentRate).toFixed(0)}`;
        };
        window.fetchWeatherForDay = async function() {
            if(!currentTrip.city) return;
            const dateStr = window.getTargetDateStr(currentTrip.startDate, appState.dayIdx);
            try {
                // Fixed: Use "name" correctly and handle "city not found" safely
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(currentTrip.city)}&count=1&language=zh&format=json`);
                const geoData = await geoRes.json();
                
                if(!geoData.results || geoData.results.length === 0) {
                     document.getElementById('weather-loc').innerText = "Êâæ‰∏çÂà∞Âú∞Èªû";
                     return;
                }
                
                const {latitude, longitude, name} = geoData.results[0];
                document.getElementById('weather-loc').innerText = name; // Update with API's found name
                
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
                const wData = await wRes.json();
                if(wData.daily) {
                    document.getElementById('weather-temp').innerText = Math.round(wData.daily.temperature_2m_max[0]);
                    document.getElementById('w-max').innerText = Math.round(wData.daily.temperature_2m_max[0]);
                    document.getElementById('w-min').innerText = Math.round(wData.daily.temperature_2m_min[0]);
                    document.getElementById('w-rise').innerText = wData.daily.sunrise[0].split('T')[1];
                    document.getElementById('w-set').innerText = wData.daily.sunset[0].split('T')[1];
                    document.getElementById('w-rain').innerText = wData.daily.precipitation_probability_max[0];
                    setWeatherIcon(wData.daily.weathercode[0]);
                }
            } catch(e) { console.error(e); }
        };
        function setWeatherIcon(code) {
            let icon='#icon-sun', t='Êô¥';
            if(code>3) { icon='#icon-cloud'; t='Èõ≤'; }
            if(code>50) { icon='#icon-rain'; t='Èõ®'; }
            document.getElementById('weather-icon-box').innerHTML = `<svg class="icon-svg"><use href="${icon}"></use></svg>`;
            document.getElementById('weather-text').innerText = t;
        }

        // --- Itinerary ---
        window.getTargetDateStr = function(startStr, dayOffset) {
            if(!startStr) return new Date().toISOString().split('T')[0]; // Safe Fallback
            const parts = startStr.split('-');
            if(parts.length !== 3) return new Date().toISOString().split('T')[0];
            const d = new Date(parts[0], parts[1]-1, parts[2]);
            d.setDate(d.getDate() + dayOffset);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        };

        window.renderAllDetail = function() {
            if (!currentTrip) return;
            const dc = document.getElementById('day-tabs-itinerary'); 
            const mc = document.getElementById('day-tabs-money'); 
            if(dc) dc.innerHTML = ''; 
            if(mc) mc.innerHTML = '';
            
            // Safe fallback for days
            const daysCount = currentTrip.days || 1; 
            const dayNames = ["ÈÄ±Êó•", "ÈÄ±‰∏Ä", "ÈÄ±‰∫å", "ÈÄ±‰∏â", "ÈÄ±Âõõ", "ÈÄ±‰∫î", "ÈÄ±ÂÖ≠"];

            for(let i=0; i<daysCount; i++) {
                const dateStr = window.getTargetDateStr(currentTrip.startDate, i);
                const d = new Date(dateStr);
                const html = `
                    <div class="d-num">DAY ${i+1}</div>
                    <div class="d-date">${d.getMonth()+1}/${d.getDate()}</div>
                    <div class="d-week">${dayNames[d.getDay()]}</div>
                `;
                
                const div = document.createElement('div'); 
                div.className=`day-chip ${i===appState.dayIdx?'active':''}`; 
                div.innerHTML=html; 
                div.onclick=()=>{
                    appState.dayIdx=i; 
                    window.renderAllDetail();
                };
                
                if(dc) dc.appendChild(div);
                
                // For Money Tab
                if(mc) {
                    const divM = div.cloneNode(true); 
                    divM.onclick=()=>{
                        appState.dayIdx=i; 
                        window.renderAllDetail(); 
                        window.renderMoney();
                    };
                    mc.appendChild(divM);
                }
            }
            window.renderItinerary(); 
            window.fetchWeatherForDay();
        };

        window.renderItinerary = function() {
            const list = document.getElementById('list-itinerary'); 
            const flightC = document.getElementById('flight-card-container'); 
            const nightStayC = document.getElementById('night-stay-container'); 
            
            if(list) list.innerHTML = '';
            if(flightC) flightC.innerHTML = '';
            if(nightStayC) nightStayC.innerHTML = '';
            
            if(!currentTrip) return;
            if(!currentTrip.itinerary) currentTrip.itinerary = [];

            let f = null, title = '';
            // Flight Logic
            if (currentTrip.flights) {
                if (appState.dayIdx === 0 && currentTrip.flights.out && currentTrip.flights.out.code) { 
                    f = currentTrip.flights.out; title = 'ÂéªÁ®ã OUTBOUND'; 
                } else if (appState.dayIdx === (currentTrip.days - 1) && currentTrip.flights.in && currentTrip.flights.in.code) { 
                    f = currentTrip.flights.in; title = 'ÂõûÁ®ã INBOUND'; 
                }
            }
            
            if (f && flightC) flightC.innerHTML = `<div class="bp-card"><div class="bp-header">${title}</div><div class="bp-body"><div class="bp-group"><span class="bp-code">${f.depAir||'DEP'}</span><span class="bp-time">${f.depTime||'--:--'}</span></div><div class="bp-center"><div style="font-size:0.8rem;">${f.airline}</div><div class="bp-line"></div><div style="color:var(--primary); font-weight:bold;">${f.code}</div><div class="bp-duration">${calcDuration(f.depTime,f.depTz,f.arrTime,f.arrTz)}</div></div><div class="bp-group"><span class="bp-code">${f.arrAir||'ARR'}</span><span class="bp-time">${f.arrTime||'--:--'}</span></div></div></div>`;

            const dateStr = window.getTargetDateStr(currentTrip.startDate, appState.dayIdx);
            let mixed = (currentTrip.itinerary||[]).filter(x=>x.dayIdx===appState.dayIdx).map(x=>({...x, src:'it'}));
            (currentTrip.charters||[]).filter(x=>x.date===dateStr).forEach(x=>mixed.push({...x, src:'charter', loc:x.from, title:x.type}));
            mixed.sort((a,b) => (a.time||'').localeCompare(b.time||''));

            const icons = { spot:'icon-spot', food:'icon-food', shop:'icon-nav-shop', transport:'icon-transport', other:'icon-star', charter:'icon-car' };

            mixed.forEach(item => {
                let timeHTML = item.time;
                let title = item.loc || item.title;
                let sub = '';
                
                if(item.type === 'transport') {
                    timeHTML = `<div class="trans-time-group"><div class="trans-t-val">${item.time}</div><div class="trans-arrow">‚Üì</div><div class="trans-t-val">${item.endTime || '--:--'}</div></div>`;
                    if(item.dest) { 
                        sub = `<div style="font-size:0.85rem; color:var(--text); margin-top:4px; display:flex; align-items:center; gap:5px;"><span>${item.loc}</span><span style="color:var(--primary);">‚ûù</span><span>${item.dest}</span></div>`; 
                        title = item.title || "ÁßªÂãï"; 
                    }
                } else { 
                    if(item.title && item.title!==item.loc) sub = `<div style="font-size:0.85rem; color:#999; margin-top:2px;">${item.title}</div>`; 
                }
                
                if(item.open) {
                     sub += `<div class="open-badge"><svg class="icon-svg"><use href="#icon-clock"></use></svg>${item.open}</div>`;
                }

                const clickAction = item.src==='charter' ? `window.openCharterModal(${item.id})` : `window.editItinerary(${item.id})`;
                const mapBtn = (item.loc || item.dest) ? `<button class="btn-map-icon" onclick="event.stopPropagation(); window.openMap(event, '${item.type==='transport'?item.dest:item.loc}')"><svg class="icon-svg icon-sm"><use href="#icon-map-pin"></use></svg></button>` : '';
                
                if(list) list.innerHTML += `<div class="timeline-item" onclick="${clickAction}"><div class="time-bubble">${timeHTML}</div><div class="it-card type-${item.type}"><div class="it-icon"><svg class="icon-svg icon-sm"><use href="#${icons[item.type]||'icon-star'}"></use></svg></div><div style="flex:1; min-width:0;"><div style="font-weight:bold; font-size:1.05rem;">${title}</div>${sub}<div style="font-size:0.85rem; color:var(--text); opacity:0.8; margin-top:4px;">${item.note||''}</div></div><div class="it-actions">${mapBtn}</div></div></div>`;
            });

            // Night Stay
            if(nightStayC) {
                const stay = (currentTrip.hotels||[]).find(h => {
                    const checkIn = new Date(h.date);
                    const checkOut = new Date(h.date);
                    checkOut.setDate(checkOut.getDate() + parseInt(h.days));
                    const currentD = new Date(dateStr);
                    return currentD >= checkIn && currentD < checkOut;
                });
                if(stay) {
                    nightStayC.innerHTML = `<div class="night-stay-box"><svg class="icon-svg"><use href="#icon-moon"></use></svg><div><div style="font-size:0.8rem; opacity:0.8;">Tonight's Stay</div><div style="font-weight:bold; font-size:1.1rem;">${stay.name}</div><div style="font-size:0.8rem;">${stay.address}</div></div></div>`;
                }
            }
        };

        window.openNewItinerary = function() {
            appState.editId = null;
            // Ê∏ÖÁ©∫
            ['i-time','i-title','i-loc','i-note','i-open','i-end-time','i-dest'].forEach(id=>document.getElementById(id).value='');
            const typeSelect = document.getElementById('i-type');
            typeSelect.value = 'spot';
            typeSelect.dispatchEvent(new Event('change')); // Trigger visibility logic
            window.openModal('itinerary');
        };
        window.editItinerary = function(id) {
            const item = currentTrip.itinerary.find(i=>i.id===id);
            if(!item) return;
            appState.editId = id;
            document.getElementById('i-time').value=item.time;
            const typeSelect = document.getElementById('i-type');
            typeSelect.value=item.type;
            typeSelect.dispatchEvent(new Event('change')); // Trigger visibility logic
            
            document.getElementById('i-title').value=item.title;
            document.getElementById('i-loc').value=item.loc;
            document.getElementById('i-note').value=item.note;
            document.getElementById('i-open').value=item.open;
            document.getElementById('i-end-time').value=item.endTime;
            document.getElementById('i-dest').value=item.dest;
            window.openModal('itinerary');
        };
        window.saveItinerary = function() {
            const time = document.getElementById('i-time').value;
            const loc = document.getElementById('i-loc').value;
            if(!time || !loc) return alert('Ë´ãÂ°´ÂØ´ÊôÇÈñìËàáÂú∞Èªû');
            const newItem = { id: appState.editId || Date.now(), dayIdx: appState.dayIdx, time, type: document.getElementById('i-type').value, title: document.getElementById('i-title').value, loc, note: document.getElementById('i-note').value, open: document.getElementById('i-open').value, endTime: document.getElementById('i-end-time').value, dest: document.getElementById('i-dest').value };
            if(appState.editId) { const idx = currentTrip.itinerary.findIndex(x=>x.id===appState.editId); if(idx!==-1) currentTrip.itinerary[idx] = newItem; } 
            else currentTrip.itinerary.push(newItem);
            window.saveData(); window.closeModal('itinerary');
        };
        window.deleteItineraryItemInModal = function() {
            if(!appState.editId) return;
            if(confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) { currentTrip.itinerary = currentTrip.itinerary.filter(x=>x.id!==appState.editId); window.saveData(); window.closeModal('itinerary'); }
        };

        document.getElementById('i-type').addEventListener('change', function() {
            const val = this.value;
            const openWrapper = document.getElementById('wrapper-open');
            const endTimeWrapper = document.getElementById('wrapper-end-time');
            const startTimeLabel = document.getElementById('label-time-start');
            const destWrapper = document.getElementById('wrapper-dest');
            const titleWrapper = document.getElementById('wrapper-title');
            const locInput = document.getElementById('i-loc');
            const destInput = document.getElementById('i-dest');
            const iTitle = document.getElementById('i-title');

            openWrapper.classList.add('hidden');
            endTimeWrapper.classList.add('hidden');
            destWrapper.classList.add('hidden');
            titleWrapper.classList.add('hidden');
            
            startTimeLabel.innerText = "ÈñãÂßãÊôÇÈñì";
            locInput.placeholder = "Google Maps Âú∞Èªû";

            if(val === 'food' || val === 'spot' || val === 'shop') {
                openWrapper.classList.remove('hidden');
            } else if (val === 'transport') {
                startTimeLabel.innerText = "Âá∫ÁôºÊôÇÈñì";
                endTimeWrapper.classList.remove('hidden');
                destWrapper.classList.remove('hidden');
                locInput.placeholder = "Âá∫ÁôºÂú∞";
                destInput.placeholder = "ÊäµÈÅîÂú∞";
                titleWrapper.classList.remove('hidden');
                iTitle.placeholder = "Áè≠Ê¨°/ËªäÁ®Æ (Â¶Ç: JRÂ±±ÊâãÁ∑ö)";
            }
        });

        window.renderHome();

    </script>
</body>
</html>
